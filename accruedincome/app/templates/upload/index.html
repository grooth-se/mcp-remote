{% extends "base.html" %}
{% block title %}Upload Files{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-11 mx-auto">
        <!-- Integration Load Card -->
        <div class="card mb-3">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-database-down"></i> Load from MG5 Integration</span>
                <span id="integrationStatus" class="badge bg-secondary">Checking...</span>
            </div>
            <div class="card-body py-2 d-flex align-items-center justify-content-between">
                <small class="text-muted">Fetch all data directly from the MG5 Integration database â€” no Excel files needed.</small>
                <form method="POST" action="{{ url_for('upload.from_integration') }}" id="integrationForm">
                    <button type="submit" class="btn btn-sm btn-success" id="integrationBtn" disabled>
                        <i class="bi bi-cloud-download"></i> Load from Integration
                    </button>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-upload"></i> Load Monitor G5 Excel Files</span>
                <a href="{{ url_for('calculation.index') }}" class="btn btn-sm btn-light">
                    <i class="bi bi-play-fill"></i> Calculate
                </a>
            </div>
            <div class="card-body py-2">
                {% if errors %}
                <div class="alert alert-warning py-1 mb-2">
                    <strong>Issues:</strong>
                    {% for error in errors %}<span class="ms-2">{{ error }}</span>{% if not loop.last %},{% endif %}{% endfor %}
                </div>
                {% endif %}

                <!-- Tab navigation -->
                <ul class="nav nav-tabs nav-sm mb-2" id="uploadTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active py-1" id="paths-tab" data-bs-toggle="tab" data-bs-target="#paths" type="button">
                            <i class="bi bi-folder2-open"></i> File Paths
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link py-1" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button">
                            <i class="bi bi-cloud-upload"></i> Browser Upload
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="uploadTabsContent">
                    <!-- File Paths Tab -->
                    <div class="tab-pane fade show active" id="paths" role="tabpanel">
                        <form method="POST" id="pathsForm">
                            <input type="hidden" name="use_paths" value="true">

                            <div class="row align-items-end mb-2">
                                <div class="col-md-8">
                                    <label class="form-label mb-0">Base Directory</label>
                                    <input type="text" class="form-control form-control-sm" id="baseDir"
                                           placeholder="/path/to/monitor/exports">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-sm btn-outline-secondary w-100" type="button" onclick="applyBaseDir()">
                                        Apply All
                                    </button>
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-sm btn-primary w-100" id="loadBtn">
                                        <i class="bi bi-folder-check"></i> Load
                                    </button>
                                </div>
                            </div>

                            <div class="row g-2">
                                {% for file_key, label in required_files.items() %}
                                <div class="col-md-6 col-lg-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text" style="min-width:90px;font-size:0.65rem;" title="{{ label }}">{{ file_key[:12] }}</span>
                                        <input type="text" class="form-control file-path"
                                               name="path_{{ file_key }}"
                                               id="path_{{ file_key }}"
                                               placeholder="{{ file_key }}.xlsx"
                                               value="{{ default_paths.get(file_key, '') }}"
                                               data-filename="{{ file_key }}.xlsx">
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </form>
                    </div>

                    <!-- Browser Upload Tab -->
                    <div class="tab-pane fade" id="upload" role="tabpanel">
                        <form method="POST" enctype="multipart/form-data" id="uploadForm">
                            <input type="hidden" name="use_paths" value="false">

                            <div class="row g-2">
                                {% for file_key, label in required_files.items() %}
                                <div class="col-md-6 col-lg-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text" style="min-width:90px;font-size:0.65rem;">{{ file_key[:12] }}</span>
                                        <input type="file" class="form-control" name="{{ file_key }}" accept=".xlsx,.xls">
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <div class="mt-2 text-end">
                                <button type="submit" class="btn btn-sm btn-primary" id="uploadBtn">
                                    <i class="bi bi-cloud-upload"></i> Upload All
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Apply base directory to all file paths
function applyBaseDir() {
    const baseDir = document.getElementById('baseDir').value.trim();
    if (!baseDir) return;
    const dir = baseDir.replace(/\/+$/, '');
    document.querySelectorAll('.file-path').forEach(input => {
        input.value = dir + '/' + input.dataset.filename;
        input.classList.remove('is-invalid');
    });
}

// Form submission handlers
document.getElementById('pathsForm').addEventListener('submit', function(e) {
    let allFilled = true;
    this.querySelectorAll('.file-path').forEach(input => {
        if (!input.value.trim()) {
            input.classList.add('is-invalid');
            allFilled = false;
        } else {
            input.classList.remove('is-invalid');
        }
    });
    if (!allFilled) {
        e.preventDefault();
    } else {
        document.getElementById('loadBtn').innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        document.getElementById('loadBtn').disabled = true;
    }
});

document.getElementById('uploadForm').addEventListener('submit', function(e) {
    let allFilled = true;
    this.querySelectorAll('input[type="file"]').forEach(input => {
        if (!input.files.length) {
            input.classList.add('is-invalid');
            allFilled = false;
        }
    });
    if (!allFilled) {
        e.preventDefault();
    } else {
        document.getElementById('uploadBtn').innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        document.getElementById('uploadBtn').disabled = true;
    }
});

// Check MG5 integration health on page load
fetch('{{ url_for("upload.integration_health") }}')
    .then(r => r.json())
    .then(data => {
        const badge = document.getElementById('integrationStatus');
        const btn = document.getElementById('integrationBtn');
        if (data.ok) {
            badge.className = 'badge bg-success';
            badge.textContent = 'Connected';
            btn.disabled = false;
        } else {
            badge.className = 'badge bg-danger';
            badge.textContent = 'Offline';
        }
    })
    .catch(() => {
        document.getElementById('integrationStatus').className = 'badge bg-danger';
        document.getElementById('integrationStatus').textContent = 'Offline';
    });

document.getElementById('integrationForm').addEventListener('submit', function() {
    const btn = document.getElementById('integrationBtn');
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Loading...';
    btn.disabled = true;
});
</script>
{% endblock %}

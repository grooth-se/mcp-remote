{% extends "base.html" %}
{% block title %}Management Reports - {{ current_date }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
    <div>
        <h4 class="mb-0"><i class="bi bi-briefcase-fill"></i> Management Reports</h4>
        <small class="text-muted">
            {{ current_date }}{% if previous_date %} vs {{ previous_date }}{% endif %}{% if year_end_date %} | YE: {{ year_end_date }}{% endif %}
        </small>
    </div>
    <form method="POST" action="{{ url_for('reports.export_management') }}" class="d-inline">
        <input type="hidden" name="current_date" value="{{ current_date }}">
        <input type="hidden" name="previous_date" value="{{ previous_date or '' }}">
        <input type="hidden" name="year_end_date" value="{{ year_end_date or '' }}">
        <button type="submit" class="btn btn-sm btn-success">
            <i class="bi bi-file-earmark-excel"></i> Excel
        </button>
    </form>
</div>

<!-- Summary Cards -->
<div class="row g-2 mb-2">
    <div class="col-6 col-md-3">
        <div class="metric-box">
            <small>Accrued Revenue</small>
            <h3>{{ "{:,.0f}".format(summary.accrued_revenue / 1000) }}K</h3>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="metric-box positive">
            <small>Order Book</small>
            <h3>{{ "{:,.0f}".format(summary.orderbook / 1000) }}K</h3>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="metric-box">
            <small>Gross Profit</small>
            <h3>{{ "{:,.0f}".format(summary.gross_profit / 1000) }}K</h3>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="metric-box {% if summary.gross_margin_pct >= 0.15 %}positive{% elif summary.gross_margin_pct < 0.10 %}negative{% endif %}">
            <small>GM %</small>
            <h3>{{ "{:.1%}".format(summary.gross_margin_pct) }}</h3>
        </div>
    </div>
</div>

<!-- Report Tabs -->
<ul class="nav nav-tabs nav-sm" id="reportTabs" role="tablist">
    <li class="nav-item">
        <button class="nav-link active py-1" id="report1-tab" data-bs-toggle="tab" data-bs-target="#report1" type="button">
            <i class="bi bi-cash-stack"></i> Report 1
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link py-1" id="report2-tab" data-bs-toggle="tab" data-bs-target="#report2" type="button">
            <i class="bi bi-graph-up"></i> Report 2
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link py-1" id="report3-tab" data-bs-toggle="tab" data-bs-target="#report3" type="button">
            <i class="bi bi-box-seam"></i> Report 3
        </button>
    </li>
</ul>

<div class="tab-content" id="reportTabsContent">
    <!-- Report 1 - Revenue -->
    <div class="tab-pane fade show active" id="report1" role="tabpanel">
        <div class="card border-top-0 rounded-0 rounded-bottom">
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height:55vh;overflow-y:auto">
                    <table class="table table-striped table-sm table-hover mb-0">
                        <thead class="sticky-top">
                            <tr>
                                <th rowspan="2">Project</th>
                                <th rowspan="2">Name</th>
                                <th colspan="4" class="text-center bg-primary text-white">Current Period</th>
                                <th colspan="4" class="text-center bg-success text-white">YTD</th>
                                <th colspan="4" class="text-center bg-info text-white">PTD</th>
                            </tr>
                            <tr>
                                <th class="text-end">Rev</th>
                                <th class="text-end">COGS</th>
                                <th class="text-end">GM</th>
                                <th class="text-end">%</th>
                                <th class="text-end">Rev</th>
                                <th class="text-end">COGS</th>
                                <th class="text-end">GM</th>
                                <th class="text-end">%</th>
                                <th class="text-end">Rev</th>
                                <th class="text-end">COGS</th>
                                <th class="text-end">GM</th>
                                <th class="text-end">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in report1 %}
                            <tr>
                                <td><code>{{ r.project_number }}</code></td>
                                <td class="text-truncate" style="max-width:100px">{{ r.project_name[:15] }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.current_revenue / 1000) }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.current_cogs / 1000) }}</td>
                                <td class="text-end {% if r.current_gm < 0 %}text-danger{% endif %}">{{ "{:,.0f}".format(r.current_gm / 1000) }}</td>
                                <td class="text-end">{{ "{:.0%}".format(r.current_gm_pct) if r.current_revenue else '-' }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.ytd_revenue / 1000) }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.ytd_cogs / 1000) }}</td>
                                <td class="text-end {% if r.ytd_gm < 0 %}text-danger{% endif %}">{{ "{:,.0f}".format(r.ytd_gm / 1000) }}</td>
                                <td class="text-end">{{ "{:.0%}".format(r.ytd_gm_pct) if r.ytd_revenue else '-' }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.ptd_revenue / 1000) }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.ptd_cogs / 1000) }}</td>
                                <td class="text-end {% if r.ptd_gm < 0 %}text-danger{% endif %}">{{ "{:,.0f}".format(r.ptd_gm / 1000) }}</td>
                                <td class="text-end">{{ "{:.0%}".format(r.ptd_gm_pct) if r.ptd_revenue else '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="sticky-bottom table-dark">
                            <tr>
                                <th colspan="2">TOTAL (K)</th>
                                <th class="text-end">{{ "{:,.0f}".format(report1_totals.current_revenue / 1000) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report1_totals.current_cogs / 1000) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report1_totals.current_gm / 1000) }}</th>
                                <th></th>
                                <th class="text-end">{{ "{:,.0f}".format(report1_totals.ytd_revenue / 1000) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report1_totals.ytd_cogs / 1000) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report1_totals.ytd_gm / 1000) }}</th>
                                <th></th>
                                <th class="text-end">{{ "{:,.0f}".format(report1_totals.ptd_revenue / 1000) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report1_totals.ptd_cogs / 1000) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report1_totals.ptd_gm / 1000) }}</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Report 2 - Valuation -->
    <div class="tab-pane fade" id="report2" role="tabpanel">
        <div class="card border-top-0 rounded-0 rounded-bottom">
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height:55vh;overflow-y:auto">
                    <table class="table table-striped table-sm table-hover mb-0">
                        <thead class="sticky-top">
                            <tr>
                                <th rowspan="2">Project</th>
                                <th rowspan="2">Name</th>
                                <th colspan="6" class="text-center bg-primary text-white">Latest Calculation</th>
                                <th colspan="4" class="text-center bg-warning">Period Changes</th>
                            </tr>
                            <tr>
                                <th class="text-end">TCV</th>
                                <th class="text-end">COGS</th>
                                <th class="text-end">GM</th>
                                <th class="text-end">%</th>
                                <th class="text-end">PoC</th>
                                <th class="text-end">Cont.</th>
                                <th class="text-end">dRev</th>
                                <th class="text-end">dCOGS</th>
                                <th class="text-end">dGM</th>
                                <th class="text-end">FX</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in report2 %}
                            <tr>
                                <td><code>{{ r.project_number }}</code></td>
                                <td class="text-truncate" style="max-width:100px">{{ r.project_name[:15] }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.tcv_revenue / 1000) }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.cogs / 1000) }}</td>
                                <td class="text-end {% if r.gm < 0 %}text-danger{% endif %}">{{ "{:,.0f}".format(r.gm / 1000) }}</td>
                                <td class="text-end">{{ "{:.0%}".format(r.gm_pct) }}</td>
                                <td class="text-end">{{ "{:.0%}".format(r.poc) }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.contingency / 1000) }}</td>
                                <td class="text-end {% if r.delta_revenue > 0 %}text-success{% elif r.delta_revenue < 0 %}text-danger{% endif %}">
                                    {{ "{:+,.0f}".format(r.delta_revenue / 1000) }}
                                </td>
                                <td class="text-end {% if r.delta_cogs > 0 %}text-danger{% elif r.delta_cogs < 0 %}text-success{% endif %}">
                                    {{ "{:+,.0f}".format(r.delta_cogs / 1000) }}
                                </td>
                                <td class="text-end {% if r.delta_gm > 0 %}text-success{% elif r.delta_gm < 0 %}text-danger{% endif %}">
                                    {{ "{:+,.0f}".format(r.delta_gm / 1000) }}
                                </td>
                                <td class="text-end">{{ "{:,.0f}".format(r.currency_effect / 1000) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="sticky-bottom table-dark">
                            <tr>
                                <th colspan="2">TOTAL (K)</th>
                                <th class="text-end">{{ "{:,.0f}".format(report2_totals.tcv_revenue / 1000) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report2_totals.cogs / 1000) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report2_totals.gm / 1000) }}</th>
                                <th></th><th></th>
                                <th class="text-end">{{ "{:,.0f}".format(report2_totals.contingency / 1000) }}</th>
                                <th class="text-end">{{ "{:+,.0f}".format(report2_totals.delta_revenue / 1000) }}</th>
                                <th class="text-end">{{ "{:+,.0f}".format(report2_totals.delta_cogs / 1000) }}</th>
                                <th class="text-end">{{ "{:+,.0f}".format(report2_totals.delta_gm / 1000) }}</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Report 3 - Order Book -->
    <div class="tab-pane fade" id="report3" role="tabpanel">
        <div class="card border-top-0 rounded-0 rounded-bottom">
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height:55vh;overflow-y:auto">
                    <table class="table table-striped table-sm table-hover mb-0">
                        <thead class="sticky-top">
                            <tr>
                                <th>Project</th>
                                <th>Name</th>
                                <th class="text-end">OB Backlog</th>
                                <th class="text-end">Intake</th>
                                <th class="text-end">Revenue</th>
                                <th class="text-end">EB Backlog</th>
                                <th class="text-end">GM%</th>
                                <th>Start</th>
                                <th>Delivery</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in report3 %}
                            <tr>
                                <td><code>{{ r.project_number }}</code></td>
                                <td class="text-truncate" style="max-width:100px">{{ r.project_name[:15] }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.ob_order_backlog / 1000) }}</td>
                                <td class="text-end {% if r.order_intake > 0 %}text-success{% endif %}">{{ "{:,.0f}".format(r.order_intake / 1000) }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.revenue / 1000) }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.eb_order_backlog / 1000) }}</td>
                                <td class="text-end">{{ "{:.0%}".format(r.gm_pct) }}</td>
                                <td>{{ r.production_start[:7] if r.production_start else '-' }}</td>
                                <td>{{ r.delivery[:7] if r.delivery else '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="sticky-bottom table-dark">
                            <tr>
                                <th colspan="2">TOTAL (K)</th>
                                <th class="text-end">{{ "{:,.0f}".format(report3_totals.ob_order_backlog / 1000) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report3_totals.order_intake / 1000) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report3_totals.revenue / 1000) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report3_totals.eb_order_backlog / 1000) }}</th>
                                <th colspan="3"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mt-2">
    <a href="{{ url_for('reports.management') }}" class="btn btn-sm btn-outline-primary">
        <i class="bi bi-arrow-left"></i> Parameters
    </a>
    <a href="{{ url_for('reports.index') }}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-table"></i> Projects
    </a>
    <a href="{{ url_for('reports.commentary') }}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-chat-text"></i> Commentary
    </a>
</div>
{% endblock %}

{% extends "base.html" %}
{% block title %}Management Reports - {{ current_date }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="bi bi-briefcase"></i> Management Reports</h2>
        <p class="text-muted">
            Current: {{ current_date }}
            {% if previous_date %} | Previous: {{ previous_date }}{% endif %}
            {% if year_end_date %} | Year End: {{ year_end_date }}{% endif %}
        </p>
        <hr>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h6>Accrued Revenue</h6>
                <h4>{{ "{:,.0f}".format(summary.accrued_revenue) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h6>Order Book</h6>
                <h4>{{ "{:,.0f}".format(summary.orderbook) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h6>Gross Profit</h6>
                <h4>{{ "{:,.0f}".format(summary.gross_profit) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning">
            <div class="card-body text-center">
                <h6>GM %</h6>
                <h4>{{ "{:.1%}".format(summary.gross_margin_pct) }}</h4>
            </div>
        </div>
    </div>
</div>

<!-- Report Tabs -->
<ul class="nav nav-tabs" id="reportTabs" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" id="report1-tab" data-bs-toggle="tab" data-bs-target="#report1" type="button">
            <i class="bi bi-cash-stack"></i> Report 1 - Revenue
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" id="report2-tab" data-bs-toggle="tab" data-bs-target="#report2" type="button">
            <i class="bi bi-graph-up"></i> Report 2 - Valuation
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" id="report3-tab" data-bs-toggle="tab" data-bs-target="#report3" type="button">
            <i class="bi bi-box-seam"></i> Report 3 - Order Book
        </button>
    </li>
</ul>

<div class="tab-content" id="reportTabsContent">
    <!-- Report 1 -->
    <div class="tab-pane fade show active" id="report1" role="tabpanel">
        <div class="card border-top-0 rounded-0 rounded-bottom">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th rowspan="2">Project</th>
                                <th rowspan="2">Name</th>
                                <th colspan="4" class="text-center table-primary">Current Period</th>
                                <th colspan="4" class="text-center table-success">Year to Date</th>
                                <th colspan="4" class="text-center table-info">Project to Date</th>
                            </tr>
                            <tr>
                                <th class="text-end">Revenue</th>
                                <th class="text-end">COGS</th>
                                <th class="text-end">GM</th>
                                <th class="text-end">GM%</th>
                                <th class="text-end">Revenue</th>
                                <th class="text-end">COGS</th>
                                <th class="text-end">GM</th>
                                <th class="text-end">GM%</th>
                                <th class="text-end">Revenue</th>
                                <th class="text-end">COGS</th>
                                <th class="text-end">GM</th>
                                <th class="text-end">GM%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in report1 %}
                            <tr>
                                <td><code>{{ r.project_number }}</code></td>
                                <td>{{ r.project_name[:20] }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.current_revenue) }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.current_cogs) }}</td>
                                <td class="text-end {% if r.current_gm < 0 %}text-danger{% endif %}">{{ "{:,.0f}".format(r.current_gm) }}</td>
                                <td class="text-end">{{ "{:.1%}".format(r.current_gm_pct) if r.current_revenue else '-' }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.ytd_revenue) }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.ytd_cogs) }}</td>
                                <td class="text-end {% if r.ytd_gm < 0 %}text-danger{% endif %}">{{ "{:,.0f}".format(r.ytd_gm) }}</td>
                                <td class="text-end">{{ "{:.1%}".format(r.ytd_gm_pct) if r.ytd_revenue else '-' }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.ptd_revenue) }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.ptd_cogs) }}</td>
                                <td class="text-end {% if r.ptd_gm < 0 %}text-danger{% endif %}">{{ "{:,.0f}".format(r.ptd_gm) }}</td>
                                <td class="text-end">{{ "{:.1%}".format(r.ptd_gm_pct) if r.ptd_revenue else '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-dark">
                            <tr>
                                <th colspan="2">TOTAL (SEK'000)</th>
                                <th class="text-end">{{ "{:,.0f}".format(report1_totals.current_revenue) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report1_totals.current_cogs) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report1_totals.current_gm) }}</th>
                                <th></th>
                                <th class="text-end">{{ "{:,.0f}".format(report1_totals.ytd_revenue) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report1_totals.ytd_cogs) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report1_totals.ytd_gm) }}</th>
                                <th></th>
                                <th class="text-end">{{ "{:,.0f}".format(report1_totals.ptd_revenue) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report1_totals.ptd_cogs) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report1_totals.ptd_gm) }}</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Report 2 -->
    <div class="tab-pane fade" id="report2" role="tabpanel">
        <div class="card border-top-0 rounded-0 rounded-bottom">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th rowspan="2">Project</th>
                                <th rowspan="2">Name</th>
                                <th colspan="6" class="text-center table-primary">Last Updated Calculation</th>
                                <th colspan="4" class="text-center table-warning">Changes Current Period</th>
                            </tr>
                            <tr>
                                <th class="text-end">TCV/Revenue</th>
                                <th class="text-end">COGS</th>
                                <th class="text-end">GM</th>
                                <th class="text-end">GM%</th>
                                <th class="text-end">PoC</th>
                                <th class="text-end">Contingency</th>
                                <th class="text-end">Revenue</th>
                                <th class="text-end">COGS</th>
                                <th class="text-end">GM</th>
                                <th class="text-end">Currency</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in report2 %}
                            <tr>
                                <td><code>{{ r.project_number }}</code></td>
                                <td>{{ r.project_name[:20] }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.tcv_revenue) }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.cogs) }}</td>
                                <td class="text-end {% if r.gm < 0 %}text-danger{% endif %}">{{ "{:,.0f}".format(r.gm) }}</td>
                                <td class="text-end">{{ "{:.1%}".format(r.gm_pct) }}</td>
                                <td class="text-end">{{ "{:.0%}".format(r.poc) }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.contingency) }}</td>
                                <td class="text-end {% if r.delta_revenue != 0 %}{% if r.delta_revenue > 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                                    {{ "{:+,.0f}".format(r.delta_revenue) if r.delta_revenue else '0' }}
                                </td>
                                <td class="text-end {% if r.delta_cogs != 0 %}{% if r.delta_cogs > 0 %}text-danger{% else %}text-success{% endif %}{% endif %}">
                                    {{ "{:+,.0f}".format(r.delta_cogs) if r.delta_cogs else '0' }}
                                </td>
                                <td class="text-end {% if r.delta_gm != 0 %}{% if r.delta_gm > 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                                    {{ "{:+,.0f}".format(r.delta_gm) if r.delta_gm else '0' }}
                                </td>
                                <td class="text-end">{{ "{:,.0f}".format(r.currency_effect) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-dark">
                            <tr>
                                <th colspan="2">TOTAL (SEK'000)</th>
                                <th class="text-end">{{ "{:,.0f}".format(report2_totals.tcv_revenue) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report2_totals.cogs) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report2_totals.gm) }}</th>
                                <th></th>
                                <th></th>
                                <th class="text-end">{{ "{:,.0f}".format(report2_totals.contingency) }}</th>
                                <th class="text-end">{{ "{:+,.0f}".format(report2_totals.delta_revenue) }}</th>
                                <th class="text-end">{{ "{:+,.0f}".format(report2_totals.delta_cogs) }}</th>
                                <th class="text-end">{{ "{:+,.0f}".format(report2_totals.delta_gm) }}</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Report 3 -->
    <div class="tab-pane fade" id="report3" role="tabpanel">
        <div class="card border-top-0 rounded-0 rounded-bottom">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th>Project</th>
                                <th>Name</th>
                                <th class="text-end">OB Order Backlog</th>
                                <th class="text-end">Order Intake</th>
                                <th class="text-end">Revenue</th>
                                <th class="text-end">EB Order Backlog</th>
                                <th class="text-end">GM%</th>
                                <th>Prod. Start</th>
                                <th>Delivery</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in report3 %}
                            <tr>
                                <td><code>{{ r.project_number }}</code></td>
                                <td>{{ r.project_name[:20] }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.ob_order_backlog) }}</td>
                                <td class="text-end {% if r.order_intake > 0 %}text-success{% endif %}">{{ "{:,.0f}".format(r.order_intake) }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.revenue) }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(r.eb_order_backlog) }}</td>
                                <td class="text-end">{{ "{:.1%}".format(r.gm_pct) }}</td>
                                <td>{{ r.production_start or '-' }}</td>
                                <td>{{ r.delivery or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-dark">
                            <tr>
                                <th colspan="2">TOTAL (SEK'000)</th>
                                <th class="text-end">{{ "{:,.0f}".format(report3_totals.ob_order_backlog) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report3_totals.order_intake) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report3_totals.revenue) }}</th>
                                <th class="text-end">{{ "{:,.0f}".format(report3_totals.eb_order_backlog) }}</th>
                                <th colspan="3"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-download"></i> Export all reports to Excel
                </span>
                <form method="POST" action="{{ url_for('reports.export_management') }}" style="display:inline;">
                    <input type="hidden" name="current_date" value="{{ current_date }}">
                    <input type="hidden" name="previous_date" value="{{ previous_date or '' }}">
                    <input type="hidden" name="year_end_date" value="{{ year_end_date or '' }}">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-file-earmark-excel"></i> Export to Excel
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="{{ url_for('reports.management') }}" class="btn btn-outline-primary">
        <i class="bi bi-arrow-left"></i> Back to Parameters
    </a>
    <a href="{{ url_for('reports.index') }}" class="btn btn-outline-secondary">
        <i class="bi bi-table"></i> Project Reports
    </a>
</div>
{% endblock %}

{% extends "base.html" %}
{% block title %}Monthly Commentary - {{ commentary.current_date }}{% endblock %}

{% block head %}
<!-- Styles defined in style.css -->
{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-2">
    <div>
        <h4 class="mb-0"><i class="bi bi-chat-text"></i> Monthly Commentary</h4>
        <small class="text-muted">
            {{ commentary.current_date }} vs {{ commentary.previous_date }}
            {% if commentary.year_end_date %} | YTD: {{ commentary.year_end_date }}{% endif %}
        </small>
    </div>
    <div class="no-print">
        <button onclick="window.print()" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-printer"></i> Print
        </button>
    </div>
</div>

<!-- Key Metrics Summary -->
<div class="row g-2 mb-2">
    <div class="col-6 col-md-3">
        <div class="metric-box">
            <small>Total Revenue</small>
            <h3>{{ "{:,.0f}".format(commentary.summary.current.revenue / 1000) }}K</h3>
            <small>
                {% set rev_change = commentary.summary.mom_change.revenue %}
                {% if rev_change >= 0 %}+{% endif %}{{ "{:,.0f}".format(rev_change / 1000) }}K
            </small>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="metric-box {% if commentary.summary.mom_change.gross_margin >= 0 %}positive{% else %}negative{% endif %}">
            <small>Gross Margin</small>
            <h3>{{ "{:.1%}".format(commentary.summary.current.gross_margin_pct) }}</h3>
            <small>
                {% set gm_change = commentary.summary.mom_change.gross_margin_pct * 100 %}
                {% if gm_change >= 0 %}+{% endif %}{{ "{:.1f}".format(gm_change) }}pp
            </small>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="metric-box">
            <small>Order Book</small>
            <h3>{{ "{:,.0f}".format(commentary.summary.current.orderbook / 1000000) }}M</h3>
            <small>
                {% set ob_change = commentary.summary.mom_change.orderbook %}
                {% if ob_change >= 0 %}+{% endif %}{{ "{:,.0f}".format(ob_change / 1000) }}K
            </small>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="metric-box">
            <small>Accrued Income</small>
            <h3>{{ "{:,.0f}".format(commentary.summary.current.accrued / 1000000) }}M</h3>
            <small>{{ commentary.summary.current.project_count }} projects</small>
        </div>
    </div>
</div>

<!-- Commentary Sections -->
<div class="row g-2">
    <!-- Revenue Section -->
    <div class="col-md-6">
        <div class="card slide-card h-100">
            <div class="card-header bg-success text-white py-1">
                <i class="bi {{ commentary.revenue_section.icon }}"></i> {{ commentary.revenue_section.title }}
            </div>
            <div class="card-body py-2">
                {% for bullet in commentary.revenue_section.bullets %}
                <div class="commentary-bullet">
                    <i class="bi bi-check-circle text-success"></i> {{ bullet }}
                </div>
                {% endfor %}

                {% if commentary.top_revenue_increases %}
                <small class="d-block mt-2 text-success"><i class="bi bi-arrow-up-circle"></i> Top Increases</small>
                <table class="table table-sm mb-0">
                    {% for h in commentary.top_revenue_increases[:3] %}
                    <tr>
                        <td><code>{{ h.project_number }}</code></td>
                        <td>{{ h.project_name[:15] }}</td>
                        <td class="text-end text-success">+{{ "{:,.0f}".format(h.change / 1000) }}K</td>
                    </tr>
                    {% endfor %}
                </table>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Margin Section -->
    <div class="col-md-6">
        <div class="card slide-card h-100">
            <div class="card-header bg-info text-white py-1">
                <i class="bi {{ commentary.margin_section.icon }}"></i> {{ commentary.margin_section.title }}
            </div>
            <div class="card-body py-2">
                {% for bullet in commentary.margin_section.bullets %}
                <div class="commentary-bullet">
                    <i class="bi bi-check-circle text-info"></i> {{ bullet }}
                </div>
                {% endfor %}

                {% if commentary.top_margin_changes %}
                <small class="d-block mt-2"><i class="bi bi-arrow-left-right"></i> Margin Changes</small>
                <table class="table table-sm mb-0">
                    {% for h in commentary.top_margin_changes[:3] %}
                    <tr>
                        <td><code>{{ h.project_number }}</code></td>
                        <td>{{ h.project_name[:15] }}</td>
                        <td class="text-end {% if h.change > 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if h.change > 0 %}+{% endif %}{{ "{:.1f}".format(h.change * 100) }}pp
                        </td>
                    </tr>
                    {% endfor %}
                </table>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row g-2 mt-2">
    <!-- Order Book Section -->
    <div class="col-md-6">
        <div class="card slide-card h-100">
            <div class="card-header bg-primary text-white py-1">
                <i class="bi {{ commentary.orderbook_section.icon }}"></i> {{ commentary.orderbook_section.title }}
            </div>
            <div class="card-body py-2">
                {% for bullet in commentary.orderbook_section.bullets %}
                <div class="commentary-bullet">
                    <i class="bi bi-check-circle text-primary"></i> {{ bullet }}
                </div>
                {% endfor %}
                <div class="row g-1 mt-2">
                    <div class="col-6">
                        <div class="text-center p-1 bg-light rounded">
                            <small class="text-muted d-block">Previous</small>
                            <strong>{{ "{:,.0f}".format(commentary.summary.previous.orderbook / 1000000) }}M</strong>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-1 bg-light rounded">
                            <small class="text-muted d-block">Current</small>
                            <strong>{{ "{:,.0f}".format(commentary.summary.current.orderbook / 1000000) }}M</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Activity Section -->
    <div class="col-md-6">
        <div class="card slide-card h-100">
            <div class="card-header bg-warning py-1">
                <i class="bi {{ commentary.project_section.icon }}"></i> {{ commentary.project_section.title }}
            </div>
            <div class="card-body py-2">
                {% for bullet in commentary.project_section.bullets %}
                <div class="commentary-bullet">
                    <i class="bi bi-check-circle text-warning"></i> {{ bullet }}
                </div>
                {% endfor %}

                {% if commentary.new_projects %}
                <small class="d-block mt-1 text-success"><i class="bi bi-plus-circle"></i> New</small>
                <table class="table table-sm mb-0">
                    {% for p in commentary.new_projects[:2] %}
                    <tr>
                        <td><code>{{ p.project_number }}</code></td>
                        <td>{{ p.project_name[:12] }}</td>
                        <td class="text-end">{{ "{:,.0f}".format(p.revenue / 1000) }}K</td>
                    </tr>
                    {% endfor %}
                </table>
                {% endif %}

                {% if commentary.completed_projects %}
                <small class="d-block mt-1 text-info"><i class="bi bi-check-circle-fill"></i> Completed</small>
                <table class="table table-sm mb-0">
                    {% for p in commentary.completed_projects[:2] %}
                    <tr>
                        <td><code>{{ p.project_number }}</code></td>
                        <td>{{ p.project_name[:12] }}</td>
                        <td class="text-end">{{ "{:.0%}".format(p.margin_pct) }}</td>
                    </tr>
                    {% endfor %}
                </table>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Risk Section & Revenue Decreases -->
<div class="row g-2 mt-2">
    <div class="col-md-6">
        <div class="card slide-card">
            <div class="card-header bg-danger text-white py-1">
                <i class="bi {{ commentary.risk_section.icon }}"></i> {{ commentary.risk_section.title }}
            </div>
            <div class="card-body py-2">
                {% for bullet in commentary.risk_section.bullets %}
                <div class="commentary-bullet">
                    <i class="bi bi-exclamation-triangle text-danger"></i> {{ bullet }}
                </div>
                {% endfor %}
                <div class="row g-1 mt-2">
                    <div class="col-6">
                        <div class="text-center p-1 bg-light rounded">
                            <small class="text-muted d-block">Contingency</small>
                            <strong>{{ "{:,.0f}".format(commentary.summary.current.contingency / 1000) }}K</strong>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-1 bg-light rounded">
                            <small class="text-muted d-block">Accrued Chg</small>
                            <strong class="{% if commentary.summary.mom_change.accrued >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if commentary.summary.mom_change.accrued >= 0 %}+{% endif %}{{ "{:,.0f}".format(commentary.summary.mom_change.accrued / 1000) }}K
                            </strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if commentary.top_revenue_decreases %}
    <div class="col-md-6">
        <div class="card slide-card">
            <div class="card-header bg-secondary text-white py-1">
                <i class="bi bi-arrow-down-circle"></i> Revenue Decreases
            </div>
            <div class="card-body py-2">
                <table class="table table-sm mb-0">
                    {% for h in commentary.top_revenue_decreases[:3] %}
                    <tr>
                        <td><code>{{ h.project_number }}</code></td>
                        <td>{{ h.project_name[:15] }}</td>
                        <td class="text-end text-danger">{{ "{:,.0f}".format(h.change / 1000) }}K</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- YTD Summary -->
{% if commentary.year_end_date %}
<div class="row g-2 mt-2">
    <div class="col-12">
        <div class="card slide-card">
            <div class="card-header bg-dark text-white py-1">
                <i class="bi bi-calendar-check"></i> YTD Summary ({{ commentary.year_end_date }})
            </div>
            <div class="card-body py-2">
                <div class="row text-center">
                    <div class="col-4">
                        <small class="text-muted d-block">YTD Revenue</small>
                        <h5 class="mb-0 {% if commentary.summary.ytd.revenue >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if commentary.summary.ytd.revenue >= 0 %}+{% endif %}{{ "{:,.0f}".format(commentary.summary.ytd.revenue / 1000000) }}M
                        </h5>
                    </div>
                    <div class="col-4">
                        <small class="text-muted d-block">YTD Cost</small>
                        <h5 class="mb-0">{{ "{:,.0f}".format(commentary.summary.ytd.cost / 1000000) }}M</h5>
                    </div>
                    <div class="col-4">
                        <small class="text-muted d-block">YTD GM</small>
                        <h5 class="mb-0 {% if commentary.summary.ytd.gross_margin >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if commentary.summary.ytd.gross_margin >= 0 %}+{% endif %}{{ "{:,.0f}".format(commentary.summary.ytd.gross_margin / 1000000) }}M
                        </h5>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Navigation -->
<div class="mt-2 no-print">
    <a href="{{ url_for('reports.commentary') }}" class="btn btn-sm btn-outline-primary">
        <i class="bi bi-arrow-left"></i> Parameters
    </a>
    <a href="{{ url_for('reports.management') }}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-briefcase-fill"></i> Management
    </a>
    <a href="{{ url_for('reports.index') }}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-table"></i> Projects
    </a>
</div>
{% endblock %}

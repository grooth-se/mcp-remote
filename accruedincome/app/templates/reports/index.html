{% extends "base.html" %}
{% block title %}Reports{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
    <h4 class="mb-0"><i class="bi bi-file-text"></i> Project Reports</h4>
    {% if closing_dates %}
    <form method="GET" action="{{ url_for('reports.index') }}" class="d-flex align-items-center gap-2">
        <label class="mb-0 text-muted small">Date:</label>
        <select name="closing_date" class="form-select form-select-sm" style="width:auto" onchange="this.form.submit()">
            {% for date in closing_dates %}
            <option value="{{ date }}" {% if date == selected_date %}selected{% endif %}>{{ date }}</option>
            {% endfor %}
        </select>
    </form>
    {% endif %}
</div>

{% if selected_date and projects %}
<div class="row g-2 mb-2">
    <div class="col-6 col-md-2">
        <div class="card h-100">
            <div class="card-body py-2 text-center">
                <small class="text-muted d-block">Projects</small>
                <strong>{{ totals.project_count }}</strong>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-2">
        <div class="card h-100">
            <div class="card-body py-2 text-center">
                <small class="text-muted d-block">Accrued</small>
                <strong class="text-success">{{ "{:,.0f}".format(totals.total_accrued / 1000) }}K</strong>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-2">
        <div class="card h-100">
            <div class="card-body py-2 text-center">
                <small class="text-muted d-block">Net</small>
                <strong>{{ "{:,.0f}".format((totals.total_accrued - totals.total_contingency) / 1000) }}K</strong>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-6">
        <div class="card h-100">
            <div class="card-body py-1 d-flex gap-1 flex-wrap align-items-center">
                <a href="{{ url_for('reports.project_report', closing_date=selected_date) }}" class="btn btn-sm btn-outline-primary">Revenue</a>
                <a href="{{ url_for('reports.orderbook_report', closing_date=selected_date) }}" class="btn btn-sm btn-outline-primary">Orderbook</a>
                <a href="{{ url_for('reports.profit_report', closing_date=selected_date) }}" class="btn btn-sm btn-outline-primary">Profit</a>
                <a href="{{ url_for('reports.booking_diff', closing_date=selected_date) }}" class="btn btn-sm btn-outline-secondary">Booking</a>
                <a href="{{ url_for('reports.charts', closing_date=selected_date) }}" class="btn btn-sm btn-outline-secondary">Charts</a>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header py-1">
        <i class="bi bi-table"></i> All Projects ({{ totals.project_count }})
    </div>
    <div class="card-body p-0">
        <div class="table-responsive" style="max-height:60vh;overflow-y:auto">
            <table class="table table-striped table-sm table-hover mb-0">
                <thead class="sticky-top">
                    <tr>
                        <th>Project</th>
                        <th>Name</th>
                        <th class="text-end">Income</th>
                        <th class="text-end">Cost</th>
                        <th class="text-end">Profit</th>
                        <th class="text-end">Accrued</th>
                        <th class="text-end">%</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in projects %}
                    <tr>
                        <td><code>{{ p.project_number }}</code></td>
                        <td class="text-truncate" style="max-width:150px" title="{{ p.project_name }}">{{ p.project_name[:20] }}</td>
                        <td class="text-end">{{ "{:,.0f}".format((p.total_income_cur or 0) / 1000) }}</td>
                        <td class="text-end">{{ "{:,.0f}".format((p.total_cost_cur or 0) / 1000) }}</td>
                        <td class="text-end {% if (p.project_profit or 0) < 0 %}text-danger{% else %}text-success{% endif %}">
                            {{ "{:,.0f}".format((p.project_profit or 0) / 1000) }}
                        </td>
                        <td class="text-end">{{ "{:,.0f}".format((p.accrued_income_cur or 0) / 1000) }}</td>
                        <td class="text-end">{{ "{:.0f}".format((p.percent_complete or 0) * 100) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-secondary sticky-bottom">
                    <tr>
                        <th colspan="2">TOTAL</th>
                        <th class="text-end">{{ "{:,.0f}".format(totals.total_income / 1000) }}K</th>
                        <th class="text-end">{{ "{:,.0f}".format(totals.total_cost / 1000) }}K</th>
                        <th class="text-end">{{ "{:,.0f}".format(totals.total_profit / 1000) }}K</th>
                        <th class="text-end">{{ "{:,.0f}".format(totals.total_accrued / 1000) }}K</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% elif not closing_dates %}
<div class="alert alert-info py-2">
    <i class="bi bi-info-circle"></i> No data available. <a href="{{ url_for('calculation.index') }}">Run a calculation</a> first.
</div>
{% else %}
<div class="alert alert-info py-2">
    <i class="bi bi-info-circle"></i> Select a closing date to view reports.
</div>
{% endif %}
{% endblock %}

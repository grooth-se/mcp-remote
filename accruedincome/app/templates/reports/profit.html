{% extends "base.html" %}
{% block title %}Profit Report{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="bi bi-graph-up-arrow"></i> Profit Report: {{ closing_date }}</h2>
        <hr>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Project</th>
                        <th class="text-end">Total Income</th>
                        <th class="text-end">Total Cost</th>
                        <th class="text-end">Profit/Loss</th>
                        <th class="text-end">Margin %</th>
                        <th class="text-end">Income Variance</th>
                        <th class="text-end">Cost Variance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in projects %}
                    <tr>
                        <td><code>{{ p.project_number }}</code></td>
                        <td class="text-end">{{ "{:,.0f}".format(p.total_income_cur or 0) }}</td>
                        <td class="text-end">{{ "{:,.0f}".format(p.total_cost_cur or 0) }}</td>
                        <td class="text-end {% if (p.project_profit or 0) < 0 %}text-danger{% else %}text-success{% endif %}">
                            <strong>{{ "{:,.0f}".format(p.project_profit or 0) }}</strong>
                        </td>
                        <td class="text-end">{{ "{:.1%}".format(p.profit_margin_cur or 0) }}</td>
                        <td class="text-end {% if (p.diff_income or 0) < 0 %}text-danger{% endif %}">
                            {{ "{:,.0f}".format(p.diff_income or 0) }}
                        </td>
                        <td class="text-end {% if (p.diff_cost or 0) > 0 %}text-danger{% endif %}">
                            {{ "{:,.0f}".format(p.diff_cost or 0) }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-secondary">
                    <tr>
                        <th>TOTAL</th>
                        <th class="text-end">{{ "{:,.0f}".format(projects|sum(attribute='total_income_cur') or 0) }}</th>
                        <th class="text-end">{{ "{:,.0f}".format(projects|sum(attribute='total_cost_cur') or 0) }}</th>
                        <th class="text-end">{{ "{:,.0f}".format(projects|sum(attribute='project_profit') or 0) }}</th>
                        <th></th>
                        <th class="text-end">{{ "{:,.0f}".format(projects|sum(attribute='diff_income') or 0) }}</th>
                        <th class="text-end">{{ "{:,.0f}".format(projects|sum(attribute='diff_cost') or 0) }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="{{ url_for('reports.index', closing_date=closing_date) }}" class="btn btn-outline-primary">
        <i class="bi bi-arrow-left"></i> Back to Reports
    </a>
</div>
{% endblock %}

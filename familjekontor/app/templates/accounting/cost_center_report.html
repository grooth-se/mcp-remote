{% extends "base.html" %}

{% block title %}Kostnadsställerapport{% endblock %}

{% block breadcrumbs %}
{% from "macros/breadcrumbs.html" import render_breadcrumbs %}
{{ render_breadcrumbs([
    ('Bokföring', url_for('accounting.index')),
    ('Kostnadsställen', url_for('accounting.cost_centers')),
    ('Rapport', none),
]) }}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-bar-chart"></i> Kostnadsställerapport{% if drilldown_code is defined and drilldown_code %} — {{ drilldown_code }}{% endif %}</h2>
    <form class="d-flex align-items-center" method="GET">
        <select name="fiscal_year_id" class="form-select form-select-sm me-2" style="width:200px;" onchange="this.form.submit()">
            {% for fy in fiscal_years %}
            <option value="{{ fy.id }}" {% if fy.id == current_fy_id %}selected{% endif %}>{{ fy.year }}</option>
            {% endfor %}
        </select>
    </form>
</div>

{% if drilldown_code is defined and drilldown_code and pnl %}
<div class="card mb-3">
    <div class="card-header">Resultaträkning — {{ drilldown_code }}</div>
    <div class="card-body">
        <h5>Intäkter</h5>
        <table class="table table-sm">
            <thead><tr><th>Konto</th><th>Namn</th><th class="text-end">Belopp</th></tr></thead>
            <tbody>
                {% for line in pnl.revenue_lines %}
                <tr><td>{{ line.account_number }}</td><td>{{ line.account_name }}</td><td class="text-end">{{ line.amount|sek }}</td></tr>
                {% endfor %}
                <tr class="fw-bold"><td colspan="2">Summa intäkter</td><td class="text-end">{{ pnl.total_revenue|sek }}</td></tr>
            </tbody>
        </table>
        <h5>Kostnader</h5>
        <table class="table table-sm">
            <thead><tr><th>Konto</th><th>Namn</th><th class="text-end">Belopp</th></tr></thead>
            <tbody>
                {% for line in pnl.expense_lines %}
                <tr><td>{{ line.account_number }}</td><td>{{ line.account_name }}</td><td class="text-end">{{ line.amount|sek }}</td></tr>
                {% endfor %}
                <tr class="fw-bold"><td colspan="2">Summa kostnader</td><td class="text-end">{{ pnl.total_expenses|sek }}</td></tr>
            </tbody>
        </table>
        <div class="alert {% if pnl.result >= 0 %}alert-success{% else %}alert-danger{% endif %}">
            <strong>Resultat: {{ pnl.result|sek }} SEK</strong>
        </div>
        <a href="{{ url_for('accounting.cost_center_report', fiscal_year_id=current_fy_id) }}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Tillbaka till översikt
        </a>
    </div>
</div>

{% elif summaries is not none %}
<div class="card">
    <div class="card-body">
        {% if summaries %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Kod</th>
                    <th>Namn</th>
                    <th class="text-end">Intäkter</th>
                    <th class="text-end">Kostnader</th>
                    <th class="text-end">Resultat</th>
                </tr>
            </thead>
            <tbody>
                {% for s in summaries %}
                <tr>
                    <td>
                        <a href="{{ url_for('accounting.cost_center_drilldown', code=s.code, fiscal_year_id=current_fy_id) }}">
                            {{ s.code }}
                        </a>
                    </td>
                    <td>{{ s.name }} {% if not s.active %}<span class="badge bg-secondary">Inaktiv</span>{% endif %}</td>
                    <td class="text-end">{{ s.revenue|sek }}</td>
                    <td class="text-end">{{ s.expenses|sek }}</td>
                    <td class="text-end {% if s.result >= 0 %}text-success{% else %}text-danger{% endif %}">{{ s.result|sek }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Inga kostnadsställen med data hittades.
        </div>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}

{% extends "base.html" %}
{% from "macros/breadcrumbs.html" import render_breadcrumbs %}
{% block title %}Aviseringar — PsalmGears{% endblock %}

{% block breadcrumbs %}
{{ render_breadcrumbs([
    {'title': 'Start', 'url': url_for('dashboard.index')},
    {'title': 'Aviseringar'}
]) }}
{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-bell"></i> Aviseringar</h2>
    <form method="POST" action="{{ url_for('notifications.mark_all') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button class="btn btn-sm btn-outline-secondary" type="submit">
            <i class="bi bi-check2-all"></i> Markera alla som lästa
        </button>
    </form>
</div>

<div class="mb-3">
    <div class="btn-group btn-group-sm">
        <a href="{{ url_for('notifications.index') }}"
           class="btn btn-outline-secondary {% if not filter_type and not filter_read %}active{% endif %}">Alla</a>
        <a href="{{ url_for('notifications.index', read='0') }}"
           class="btn btn-outline-secondary {% if filter_read == '0' %}active{% endif %}">Olästa</a>
        <a href="{{ url_for('notifications.index', type='overdue_invoice') }}"
           class="btn btn-outline-secondary {% if filter_type == 'overdue_invoice' %}active{% endif %}">Förfallna</a>
        <a href="{{ url_for('notifications.index', type='upcoming_deadline') }}"
           class="btn btn-outline-secondary {% if filter_type == 'upcoming_deadline' %}active{% endif %}">Deadlines</a>
        <a href="{{ url_for('notifications.index', type='document_expiry') }}"
           class="btn btn-outline-secondary {% if filter_type == 'document_expiry' %}active{% endif %}">Dokument</a>
        <a href="{{ url_for('notifications.index', type='budget_variance') }}"
           class="btn btn-outline-secondary {% if filter_type == 'budget_variance' %}active{% endif %}">Budget</a>
    </div>
</div>

{% if pagination.items %}
<div class="table-responsive">
    <table class="table table-hover table-sm">
        <thead>
            <tr>
                <th style="width: 40px;"></th>
                <th>Avisering</th>
                <th>Meddelande</th>
                <th>Datum</th>
                <th>Status</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for n in pagination.items %}
            <tr class="{% if not n.read %}table-info{% endif %}">
                <td><i class="{{ n.icon }}"></i></td>
                <td>
                    {% if n.link %}<a href="{{ n.link }}">{{ n.title }}</a>{% else %}{{ n.title }}{% endif %}
                </td>
                <td class="text-muted small">{{ n.message or '' }}</td>
                <td class="text-muted small">{{ n.created_at.strftime('%Y-%m-%d %H:%M') if n.created_at else '' }}</td>
                <td>
                    {% if n.read %}
                    <span class="badge bg-secondary">Läst</span>
                    {% else %}
                    <span class="badge bg-primary">Ny</span>
                    {% endif %}
                </td>
                <td>
                    {% if not n.read %}
                    <form method="POST" action="{{ url_for('notifications.mark_read', notification_id=n.id) }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button class="btn btn-sm btn-outline-secondary" type="submit" title="Markera som läst">
                            <i class="bi bi-check2"></i>
                        </button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if pagination.pages > 1 %}
<nav>
    <ul class="pagination pagination-sm justify-content-center">
        {% if pagination.has_prev %}
        <li class="page-item"><a class="page-link" href="{{ url_for('notifications.index', page=pagination.prev_num, type=filter_type, read=filter_read) }}">&laquo;</a></li>
        {% endif %}
        {% for p in pagination.iter_pages() %}
            {% if p %}
            <li class="page-item {% if p == pagination.page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('notifications.index', page=p, type=filter_type, read=filter_read) }}">{{ p }}</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
            {% endif %}
        {% endfor %}
        {% if pagination.has_next %}
        <li class="page-item"><a class="page-link" href="{{ url_for('notifications.index', page=pagination.next_num, type=filter_type, read=filter_read) }}">&raquo;</a></li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="text-center py-5 text-muted">
    <i class="bi bi-bell-slash" style="font-size: 3rem;"></i>
    <p class="mt-2">Inga aviseringar</p>
</div>
{% endif %}
{% endblock %}

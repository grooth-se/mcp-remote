{% extends "base.html" %}
{% block title %}Avvikelseanalys - Familjekontor{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-bar-chart-line"></i> Avvikelseanalys {{ fy.year if fy else '' }}</h2>
    <a href="{{ url_for('budget.variance_excel', fiscal_year_id=fy.id if fy else '') }}" class="btn btn-outline-secondary">
        <i class="bi bi-file-earmark-excel"></i> Exportera Excel
    </a>
</div>

{% if variance %}
<div class="card mb-4">
    <div class="card-body">
        <canvas id="varianceChart" height="200" role="img" aria-label="Stapeldiagram: budget vs utfall"></canvas>
    </div>
</div>
{% endif %}

<div class="card">
    <div class="table-responsive">
        <table class="table table-sm mb-0">
            <thead class="table-light">
                <tr>
                    <th>Konto</th><th>Namn</th>
                    <th class="text-end">Budget</th>
                    <th class="text-end">Utfall</th>
                    <th class="text-end">Avvikelse</th>
                    <th class="text-end">%</th>
                </tr>
            </thead>
            <tbody>
                {% for item in variance %}
                {% if item.budget_total != 0 or item.actual_total != 0 %}
                <tr>
                    <td><strong>{{ item.number }}</strong></td>
                    <td>{{ item.name }}</td>
                    <td class="text-end">{{ "{:,.0f}".format(item.budget_total) }}</td>
                    <td class="text-end">{{ "{:,.0f}".format(item.actual_total) }}</td>
                    <td class="text-end {% if item.variance_total > 0 %}text-danger{% elif item.variance_total < 0 %}text-success{% endif %}">
                        {{ "{:,.0f}".format(item.variance_total) }}
                    </td>
                    <td class="text-end {% if item.variance_pct > 10 %}text-danger{% elif item.variance_pct < -10 %}text-success{% endif %}">
                        {{ item.variance_pct }}%
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="mt-2">
    <small class="text-muted">
        <span class="text-danger">Röd</span> = över budget,
        <span class="text-success">Grön</span> = under budget
    </small>
</div>
{% endblock %}

{% block scripts %}
{% if variance %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
(function() {
    var allData = [
        {% for item in variance %}
        {% if item.budget_total != 0 or item.actual_total != 0 %}
        { label: '{{ item.number }} {{ item.name }}', budget: {{ item.budget_total }}, actual: {{ item.actual_total }} },
        {% endif %}
        {% endfor %}
    ];
    // Show top 10 by absolute variance
    allData.sort(function(a, b) { return Math.abs(b.actual - b.budget) - Math.abs(a.actual - a.budget); });
    var data = allData.slice(0, 10);

    var ctx = document.getElementById('varianceChart');
    if (ctx && data.length > 0) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(function(d) { return d.label; }),
                datasets: [
                    {
                        label: 'Budget',
                        data: data.map(function(d) { return d.budget; }),
                        backgroundColor: 'rgba(13, 110, 253, 0.6)',
                        borderColor: 'rgba(13, 110, 253, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Utfall',
                        data: data.map(function(d) { return d.actual; }),
                        backgroundColor: data.map(function(d) {
                            return d.actual > d.budget ? 'rgba(220, 53, 69, 0.6)' : 'rgba(25, 135, 84, 0.6)';
                        }),
                        borderColor: data.map(function(d) {
                            return d.actual > d.budget ? 'rgba(220, 53, 69, 1)' : 'rgba(25, 135, 84, 1)';
                        }),
                        borderWidth: 1
                    }
                ]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'Topp 10 avvikelser: Budget vs Utfall' }
                },
                scales: {
                    x: {
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('sv-SE') + ' kr';
                            }
                        }
                    }
                }
            }
        });
    }
})();
</script>
{% endif %}
{% endblock %}

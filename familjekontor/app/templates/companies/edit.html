{% extends "base.html" %}
{% block title %}Redigera {{ company.name }} - Familjekontor{% endblock %}
{% block content %}
<h2><i class="bi bi-pencil"></i> Redigera {{ company.name }}</h2>
<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">Företagsinformation</div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    <div class="mb-3">
                        {{ form.name.label(class="form-label") }}
                        {{ form.name(class="form-control") }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Org.nummer</label>
                        <input type="text" class="form-control" value="{{ company.org_number }}" disabled>
                        <input type="hidden" name="org_number" value="{{ company.org_number }}">
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            {{ form.accounting_standard.label(class="form-label") }}
                            {{ form.accounting_standard(class="form-select") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.vat_period.label(class="form-label") }}
                            {{ form.vat_period(class="form-select") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.base_currency.label(class="form-label") }}
                            {{ form.base_currency(class="form-select") }}
                        </div>
                    </div>

                    <hr>
                    <h6 class="text-muted mb-3">Adress</h6>
                    <div class="mb-3">
                        {{ form.street_address.label(class="form-label") }}
                        {{ form.street_address(class="form-control") }}
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3">
                            {{ form.postal_code.label(class="form-label") }}
                            {{ form.postal_code(class="form-control") }}
                        </div>
                        <div class="col-md-5">
                            {{ form.city.label(class="form-label") }}
                            {{ form.city(class="form-control") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.country.label(class="form-label") }}
                            {{ form.country(class="form-control") }}
                        </div>
                    </div>

                    <hr>
                    <h6 class="text-muted mb-3">Logotyp</h6>
                    {% if company.logo_path %}
                    <div class="mb-3 d-flex align-items-center gap-3" id="logoPreview">
                        <img src="{{ url_for('companies.serve_logo', company_id=company.id) }}"
                             alt="Logotyp" style="max-height: 60px; max-width: 100px; object-fit: contain;" class="rounded border">
                        <button type="button" class="btn btn-sm btn-outline-danger" id="deleteLogoBtn"
                                data-url="{{ url_for('companies.delete_logo', company_id=company.id) }}"
                                data-csrf="{{ csrf_token() }}">
                            <i class="bi bi-trash"></i> Ta bort logotyp
                        </button>
                    </div>
                    {% endif %}
                    <div class="mb-3">
                        {{ form.logo.label(class="form-label") }}
                        {{ form.logo(class="form-control") }}
                        <div class="form-text">JPG, PNG, GIF eller SVG. Max 16 MB.</div>
                    </div>

                    <hr>
                    <h6 class="text-muted mb-3">Färgtema</h6>
                    <div class="mb-3">
                        <div class="d-flex gap-2 mb-2">
                            {% for color in ['#3B82F6', '#10B981', '#EF4444', '#8B5CF6', '#F59E0B', '#EC4899', '#06B6D4', '#6B7280'] %}
                            <button type="button" class="color-swatch rounded border-0"
                                    style="width:32px; height:32px; background-color:{{ color }}; cursor:pointer;{% if company.theme_color == color %} outline: 3px solid #000; outline-offset: 2px;{% endif %}"
                                    data-color="{{ color }}"
                                    title="{{ color }}"></button>
                            {% endfor %}
                        </div>
                        {{ form.theme_color.label(class="form-label") }}
                        <div class="d-flex align-items-center gap-2">
                            <input type="text" class="form-control" style="max-width:120px;"
                                   id="themeColorInput" name="theme_color"
                                   value="{{ form.theme_color.data or '' }}"
                                   placeholder="#3B82F6" maxlength="7">
                            <input type="color" id="colorPicker"
                                   value="{{ company.theme_color or '#3B82F6' }}"
                                   style="width:40px; height:32px; padding:0; border:1px solid #dee2e6; cursor:pointer;"
                                   title="Välj valfri färg">
                            <span id="colorPreview" class="d-inline-block rounded border"
                                  style="width:32px; height:32px; background-color:{{ company.theme_color or '#ffffff' }};"></span>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="clearColor"{% if not company.theme_color %} style="display:none;"{% endif %}>Rensa</button>
                        </div>
                        <div class="form-text">Välj en färg ovan, använd färgväljaren, eller ange en hex-kod (t.ex. #3B82F6).</div>
                    </div>

                    <div class="d-flex gap-2 mt-4">
                        {{ form.submit(class="btn btn-primary") }}
                        <a href="{{ url_for('companies.view', company_id=company.id) }}" class="btn btn-secondary">Avbryt</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const input = document.getElementById('themeColorInput');
const preview = document.getElementById('colorPreview');
const picker = document.getElementById('colorPicker');
const clearBtn = document.getElementById('clearColor');

function setColor(color) {
    input.value = color;
    preview.style.backgroundColor = color;
    picker.value = color;
    clearBtn.style.display = '';
    document.querySelectorAll('.color-swatch').forEach(b => {
        if (b.dataset.color === color) {
            b.style.outline = '3px solid #000';
            b.style.outlineOffset = '2px';
        } else {
            b.style.outline = '';
        }
    });
}

document.querySelectorAll('.color-swatch').forEach(btn => {
    btn.addEventListener('click', () => setColor(btn.dataset.color));
});

picker.addEventListener('input', () => setColor(picker.value));

input.addEventListener('input', () => {
    const val = input.value;
    if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
        preview.style.backgroundColor = val;
        picker.value = val;
        clearBtn.style.display = '';
    }
});

clearBtn.addEventListener('click', () => {
    input.value = '';
    preview.style.backgroundColor = '#ffffff';
    picker.value = '#3B82F6';
    clearBtn.style.display = 'none';
    document.querySelectorAll('.color-swatch').forEach(b => b.style.outline = '');
});

const deleteLogoBtn = document.getElementById('deleteLogoBtn');
if (deleteLogoBtn) {
    deleteLogoBtn.addEventListener('click', () => {
        if (!confirm('Ta bort logotypen?')) return;
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = deleteLogoBtn.dataset.url;
        const csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = 'csrf_token';
        csrf.value = deleteLogoBtn.dataset.csrf;
        form.appendChild(csrf);
        document.body.appendChild(form);
        form.submit();
    });
}
</script>
{% endblock %}

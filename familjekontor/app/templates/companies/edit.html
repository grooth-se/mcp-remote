{% extends "base.html" %}
{% block title %}Redigera {{ company.name }} - Familjekontor{% endblock %}
{% block content %}
<h2><i class="bi bi-pencil"></i> Redigera {{ company.name }}</h2>
<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">Företagsinformation</div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    <div class="mb-3">
                        {{ form.name.label(class="form-label") }}
                        {{ form.name(class="form-control") }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Org.nummer</label>
                        <input type="text" class="form-control" value="{{ company.org_number }}" disabled>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            {{ form.accounting_standard.label(class="form-label") }}
                            {{ form.accounting_standard(class="form-select") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.vat_period.label(class="form-label") }}
                            {{ form.vat_period(class="form-select") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.base_currency.label(class="form-label") }}
                            {{ form.base_currency(class="form-select") }}
                        </div>
                    </div>

                    <hr>
                    <h6 class="text-muted mb-3">Adress</h6>
                    <div class="mb-3">
                        {{ form.street_address.label(class="form-label") }}
                        {{ form.street_address(class="form-control") }}
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3">
                            {{ form.postal_code.label(class="form-label") }}
                            {{ form.postal_code(class="form-control") }}
                        </div>
                        <div class="col-md-5">
                            {{ form.city.label(class="form-label") }}
                            {{ form.city(class="form-control") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.country.label(class="form-label") }}
                            {{ form.country(class="form-control") }}
                        </div>
                    </div>

                    <hr>
                    <h6 class="text-muted mb-3">Logotyp</h6>
                    {% if company.logo_path %}
                    <div class="mb-3 d-flex align-items-center gap-3">
                        <img src="{{ url_for('companies.serve_logo', company_id=company.id) }}"
                             alt="Logotyp" style="max-height: 60px; max-width: 100px; object-fit: contain;" class="rounded border">
                        <form method="POST" action="{{ url_for('companies.delete_logo', company_id=company.id) }}" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-trash"></i> Ta bort logotyp
                            </button>
                        </form>
                    </div>
                    {% endif %}
                    <div class="mb-3">
                        {{ form.logo.label(class="form-label") }}
                        {{ form.logo(class="form-control") }}
                        <div class="form-text">JPG, PNG, GIF eller SVG. Max 16 MB.</div>
                    </div>

                    <hr>
                    <h6 class="text-muted mb-3">Färgtema</h6>
                    <div class="mb-3">
                        <div class="d-flex gap-2 mb-2">
                            {% for color in ['#3B82F6', '#10B981', '#EF4444', '#8B5CF6', '#F59E0B', '#EC4899', '#06B6D4', '#6B7280'] %}
                            <button type="button" class="color-swatch rounded border-0"
                                    style="width:32px; height:32px; background-color:{{ color }}; cursor:pointer;{% if company.theme_color == color %} outline: 3px solid #000; outline-offset: 2px;{% endif %}"
                                    data-color="{{ color }}"
                                    title="{{ color }}"></button>
                            {% endfor %}
                        </div>
                        {{ form.theme_color.label(class="form-label") }}
                        <div class="d-flex align-items-center gap-2">
                            {{ form.theme_color(class="form-control", style="max-width:120px;", id="themeColorInput", placeholder="#3B82F6") }}
                            <span id="colorPreview" class="d-inline-block rounded border"
                                  style="width:32px; height:32px; background-color:{{ company.theme_color or '#ffffff' }};"></span>
                            {% if company.theme_color %}
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="clearColor">Rensa</button>
                            {% endif %}
                        </div>
                        <div class="form-text">Välj en färg ovan eller ange en hex-kod (t.ex. #3B82F6).</div>
                    </div>

                    <div class="d-flex gap-2 mt-4">
                        {{ form.submit(class="btn btn-primary") }}
                        <a href="{{ url_for('companies.view', company_id=company.id) }}" class="btn btn-secondary">Avbryt</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.querySelectorAll('.color-swatch').forEach(btn => {
    btn.addEventListener('click', () => {
        const color = btn.dataset.color;
        document.getElementById('themeColorInput').value = color;
        document.getElementById('colorPreview').style.backgroundColor = color;
        document.querySelectorAll('.color-swatch').forEach(b => b.style.outline = '');
        btn.style.outline = '3px solid #000';
        btn.style.outlineOffset = '2px';
    });
});

const input = document.getElementById('themeColorInput');
input.addEventListener('input', () => {
    const val = input.value;
    if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
        document.getElementById('colorPreview').style.backgroundColor = val;
    }
});

const clearBtn = document.getElementById('clearColor');
if (clearBtn) {
    clearBtn.addEventListener('click', () => {
        input.value = '';
        document.getElementById('colorPreview').style.backgroundColor = '#ffffff';
        document.querySelectorAll('.color-swatch').forEach(b => b.style.outline = '');
    });
}
</script>
{% endblock %}

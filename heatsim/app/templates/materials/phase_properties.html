{% extends "base.html" %}

{% block title %}Phase Properties - {{ grade.designation }}{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('materials.index') }}">Materials</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('materials.view', id=grade.id) }}">{{ grade.designation }}</a></li>
        <li class="breadcrumb-item active">Phase Properties</li>
    </ol>
</nav>

<div class="row mb-3">
    <div class="col">
        <h2>
            <i class="bi bi-diagram-3"></i> Phase Properties
            <small class="text-muted">{{ grade.designation }}</small>
        </h2>
        <p class="text-muted">
            Define relative density and thermal expansion coefficients for different crystallographic phases.
            These parameters are used for volume change and residual stress calculations.
        </p>
    </div>
</div>

<div class="row">
    <!-- Existing Phase Properties -->
    <div class="col-md-7">
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-list-ul"></i> Defined Phase Properties
            </div>
            <div class="card-body p-0">
                {% if phase_props %}
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Phase</th>
                            <th>Relative Density</th>
                            <th>Expansion (µ/K)</th>
                            <th>Type</th>
                            <th>Ref. Temp</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pp in phase_props %}
                        <tr>
                            <td class="fw-bold">{{ pp.phase_label }}</td>
                            <td>{{ '%.4f'|format(pp.relative_density) if pp.relative_density else '-' }}</td>
                            <td>
                                {% if pp.thermal_expansion_coeff %}
                                    {{ '%.2f'|format(pp.thermal_expansion_coeff * 1e6) }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if pp.is_expansion_temperature_dependent %}
                                <span class="badge bg-info">T-dependent</span>
                                {% else %}
                                <span class="badge bg-secondary">Constant</span>
                                {% endif %}
                            </td>
                            <td>{{ pp.reference_temperature|round(0)|int }} °C</td>
                            <td>
                                <form method="post" action="{{ url_for('materials.delete_phase_property', id=grade.id, pp_id=pp.id) }}" class="d-inline" onsubmit="return confirm('Delete this phase property?');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-inbox fs-1"></i>
                    <p>No phase properties defined yet</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Phase Plots -->
        {% if phase_props %}
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-graph-up"></i> Phase Property Plots
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6>Relative Density by Phase</h6>
                        <img src="{{ url_for('materials.phase_plot', id=grade.id, plot_type='density') }}?t={{ now|default(1) }}"
                             class="img-fluid rounded border" alt="Density Plot"
                             onerror="this.style.display='none'">
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6>Thermal Expansion by Phase</h6>
                        <img src="{{ url_for('materials.phase_plot', id=grade.id, plot_type='expansion') }}?t={{ now|default(1) }}"
                             class="img-fluid rounded border" alt="Expansion Plot"
                             onerror="this.style.display='none'">
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <h6>Thermal Expansion vs Temperature</h6>
                        <img src="{{ url_for('materials.phase_plot', id=grade.id, plot_type='expansion_vs_temp') }}?t={{ now|default(1) }}"
                             class="img-fluid rounded border" alt="Expansion vs Temperature Plot"
                             onerror="this.style.display='none'">
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Add/Edit Phase Property Form -->
    <div class="col-md-5">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-plus-circle"></i> Add / Update Phase Property
            </div>
            <div class="card-body">
                <form method="post">
                    {{ form.hidden_tag() }}

                    <div class="mb-3">
                        {{ form.phase.label(class='form-label') }}
                        {{ form.phase(class='form-select') }}
                        <small class="text-muted">Select the crystallographic phase</small>
                    </div>

                    <hr>
                    <h6><i class="bi bi-box"></i> Density</h6>

                    <div class="mb-3">
                        {{ form.relative_density.label(class='form-label') }}
                        {{ form.relative_density(class='form-control') }}
                        <small class="text-muted">
                            Reference: Ferrite at 20°C = 1.000<br>
                            Typical values: Austenite ~0.980, Martensite ~0.978
                        </small>
                    </div>

                    <hr>
                    <h6><i class="bi bi-arrows-expand"></i> Thermal Expansion</h6>

                    <div class="mb-3">
                        {{ form.thermal_expansion_coeff.label(class='form-label') }}
                        {{ form.thermal_expansion_coeff(class='form-control') }}
                        <small class="text-muted">
                            Typical: Ferrite ~12, Austenite ~18-22
                        </small>
                    </div>

                    <div class="mb-3">
                        {{ form.expansion_type.label(class='form-label') }}
                        {{ form.expansion_type(class='form-select', id='expansion_type') }}
                    </div>

                    <div class="mb-3" id="expansion_data_container" style="display: none;">
                        {{ form.expansion_data.label(class='form-label') }}
                        {{ form.expansion_data(class='form-control', rows=4) }}
                        <small class="text-muted">
                            JSON format with temperature (°C) and values (µ/K)
                        </small>
                    </div>

                    <hr>
                    <h6><i class="bi bi-thermometer"></i> Reference</h6>

                    <div class="mb-3">
                        {{ form.reference_temperature.label(class='form-label') }}
                        {{ form.reference_temperature(class='form-control') }}
                    </div>

                    <div class="mb-3">
                        {{ form.notes.label(class='form-label') }}
                        {{ form.notes(class='form-control') }}
                    </div>

                    <div class="d-grid">
                        {{ form.submit(class='btn btn-primary') }}
                    </div>
                </form>
            </div>
        </div>

        <!-- Reference Data Card -->
        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Typical Phase Properties (Low-Alloy Steel)
            </div>
            <div class="card-body small">
                <table class="table table-sm mb-0">
                    <thead>
                        <tr>
                            <th>Phase</th>
                            <th>Rel. Density</th>
                            <th>α (µ/K)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Ferrite (α)</td><td>1.0000</td><td>11-13</td></tr>
                        <tr><td>Austenite (γ)</td><td>0.978-0.982</td><td>18-22</td></tr>
                        <tr><td>Martensite</td><td>0.976-0.980</td><td>10-12</td></tr>
                        <tr><td>Bainite</td><td>0.985-0.990</td><td>11-13</td></tr>
                        <tr><td>Pearlite</td><td>0.995-1.000</td><td>11-13</td></tr>
                    </tbody>
                </table>
                <p class="text-muted mt-2 mb-0">
                    Note: Values depend on carbon content, alloying elements, and temperature range.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// Toggle expansion data visibility
document.getElementById('expansion_type').addEventListener('change', function() {
    const container = document.getElementById('expansion_data_container');
    if (this.value === 'temperature_dependent') {
        container.style.display = 'block';
    } else {
        container.style.display = 'none';
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const expansionType = document.getElementById('expansion_type');
    if (expansionType.value === 'temperature_dependent') {
        document.getElementById('expansion_data_container').style.display = 'block';
    }
});
</script>
{% endblock %}

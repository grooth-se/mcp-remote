{% extends "base.html" %}

{% block title %}Composition - {{ grade.designation }}{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('materials.index') }}">Materials</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('materials.view', id=grade.id) }}">{{ grade.designation }}</a></li>
        <li class="breadcrumb-item active">Composition</li>
    </ol>
</nav>

<h2>
    <i class="bi bi-percent"></i> Chemical Composition
    <small class="text-muted">- {{ grade.designation }}</small>
</h2>
<p class="text-muted">
    Enter chemical composition (wt%) for hardness prediction using Maynier equations.
</p>

<form method="post">
    {{ form.hidden_tag() }}

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-1-circle"></i> Primary Elements
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">{{ form.carbon.label.text }} <span class="text-danger">*</span></label>
                            {{ form.carbon(class="form-control") }}
                            {% if form.carbon.errors %}
                            <div class="text-danger small">{{ form.carbon.errors[0] }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">{{ form.manganese.label.text }}</label>
                            {{ form.manganese(class="form-control") }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">{{ form.silicon.label.text }}</label>
                            {{ form.silicon(class="form-control") }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-2-circle"></i> Secondary Alloying Elements
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">{{ form.chromium.label.text }}</label>
                            {{ form.chromium(class="form-control") }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">{{ form.nickel.label.text }}</label>
                            {{ form.nickel(class="form-control") }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">{{ form.molybdenum.label.text }}</label>
                            {{ form.molybdenum(class="form-control") }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">{{ form.vanadium.label.text }}</label>
                            {{ form.vanadium(class="form-control") }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collapsible additional elements -->
            <div class="card mb-3">
                <div class="card-header">
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#additionalElements">
                        <i class="bi bi-3-circle"></i> Additional Elements
                        <i class="bi bi-chevron-down float-end"></i>
                    </a>
                </div>
                <div id="additionalElements" class="collapse">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">{{ form.tungsten.label.text }}</label>
                                {{ form.tungsten(class="form-control") }}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">{{ form.copper.label.text }}</label>
                                {{ form.copper(class="form-control") }}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">{{ form.phosphorus.label.text }}</label>
                                {{ form.phosphorus(class="form-control") }}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">{{ form.sulfur.label.text }}</label>
                                {{ form.sulfur(class="form-control") }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">{{ form.nitrogen.label.text }}</label>
                                {{ form.nitrogen(class="form-control") }}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">{{ form.boron.label.text }}</label>
                                {{ form.boron(class="form-control") }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-info-circle"></i> Metadata
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">{{ form.source.label.text }}</label>
                        {{ form.source(class="form-control") }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ form.notes.label.text }}</label>
                        {{ form.notes(class="form-control") }}
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2">
                {{ form.submit(class="btn btn-primary") }}
                <a href="{{ url_for('materials.view', id=grade.id) }}" class="btn btn-outline-secondary">Cancel</a>
                {% if existing %}
                <form method="post" action="{{ url_for('materials.delete_composition', id=grade.id) }}" class="ms-auto" onsubmit="return confirm('Delete this composition?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-danger">
                        <i class="bi bi-trash"></i> Delete Composition
                    </button>
                </form>
                {% endif %}
            </div>
        </div>

        <div class="col-md-4">
            {% if existing %}
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-calculator"></i> Calculated Values
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td>Carbon Equivalent (IIW)</td>
                            <td class="fw-bold">{{ '%.3f'|format(existing.carbon_equivalent_iiw) }}</td>
                        </tr>
                        <tr>
                            <td>Carbon Equivalent (Pcm)</td>
                            <td class="fw-bold">{{ '%.3f'|format(existing.carbon_equivalent_pcm) }}</td>
                        </tr>
                        <tr>
                            <td>Ideal Diameter (DI)</td>
                            <td class="fw-bold">{{ '%.2f'|format(existing.ideal_diameter_di) }} in</td>
                        </tr>
                    </table>
                    <small class="text-muted">
                        CE(IIW) = C + Mn/6 + (Cr+Mo+V)/5 + (Ni+Cu)/15<br>
                        Pcm = C + Si/30 + (Mn+Cu+Cr)/20 + Ni/60 + Mo/15 + V/10 + 5B
                    </small>
                </div>
            </div>
            {% endif %}

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-lightbulb"></i> Reference Compositions
                </div>
                <div class="card-body small">
                    <p class="fw-bold mb-1">AISI 4340 (typical)</p>
                    <p class="text-muted mb-2">C=0.40, Mn=0.70, Si=0.25, Cr=0.80, Ni=1.80, Mo=0.25</p>

                    <p class="fw-bold mb-1">AISI 4130 (typical)</p>
                    <p class="text-muted mb-2">C=0.30, Mn=0.50, Si=0.25, Cr=0.95, Mo=0.20</p>

                    <p class="fw-bold mb-1">AISI 1045 (typical)</p>
                    <p class="text-muted mb-0">C=0.45, Mn=0.75, Si=0.25</p>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

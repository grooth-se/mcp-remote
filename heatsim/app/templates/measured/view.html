{% extends "base.html" %}

{% block title %}{{ md.name }}{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('measured.index') }}">Measured Data</a></li>
        <li class="breadcrumb-item active">{{ md.name }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-clipboard-data"></i> {{ md.name }}</h2>
    <div>
        <a href="{{ url_for('simulation.view', id=md.simulation_id) }}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-thermometer-half"></i> View Simulation
        </a>
        <form method="post" action="{{ url_for('measured.delete', data_id=md.id) }}" class="d-inline"
              onsubmit="return confirm('Delete this measured data?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-trash"></i> Delete
            </button>
        </form>
    </div>
</div>

<!-- Info Cards -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="text-muted small">Simulation</div>
                <div class="fw-bold">
                    <a href="{{ url_for('simulation.view', id=md.simulation_id) }}" class="text-decoration-none">
                        {{ md.simulation.name }}
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="text-muted small">Process Step</div>
                <div class="fw-bold">
                    <span class="badge {% if md.process_step == 'heating' %}bg-warning text-dark{% elif md.process_step == 'quenching' %}bg-info{% elif md.process_step == 'tempering' %}bg-secondary{% else %}bg-primary{% endif %}">
                        {{ (md.process_step or 'full')|title }}
                    </span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="text-muted small">Duration</div>
                <div class="fw-bold">{{ md.duration_seconds|round(1) if md.duration_seconds else '-' }}s</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="text-muted small">Channels / Points</div>
                <div class="fw-bold">{{ md.num_channels }} / {{ md.num_points }}</div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Preview Plot -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up"></i> Temperature vs Time
            </div>
            <div class="card-body text-center">
                <img src="{{ url_for('simulation.measured_tc_plot_step', id=md.simulation_id, step=md.process_step or 'full') }}"
                     class="img-fluid" alt="Temperature plot">
            </div>
        </div>
    </div>

    <!-- Channel Statistics -->
    <div class="col-lg-4">
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-bar-chart"></i> Channel Statistics
            </div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <thead class="table-light">
                        <tr><th>Channel</th><th>Label</th><th>Min</th><th>Max</th><th>Avg</th></tr>
                    </thead>
                    <tbody>
                        {% set stats = md.statistics %}
                        {% for ch in md.available_channels %}
                        <tr>
                            <td><small class="fw-bold">{{ ch }}</small></td>
                            <td><small>{{ md.get_channel_label(ch) }}</small></td>
                            {% if stats.get(ch) %}
                            <td><small>{{ stats[ch].min|round(1) }}</small></td>
                            <td><small>{{ stats[ch].max|round(1) }}</small></td>
                            <td><small>{{ stats[ch].avg|round(1) }}</small></td>
                            {% else %}
                            <td><small>-</small></td><td><small>-</small></td><td><small>-</small></td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> File Info
            </div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tbody>
                        <tr><td class="text-muted">Filename</td><td>{{ md.filename or '-' }}</td></tr>
                        {% if md.description %}
                        <tr><td class="text-muted">Description</td><td>{{ md.description }}</td></tr>
                        {% endif %}
                        {% if md.start_time %}
                        <tr><td class="text-muted">Start</td><td>{{ md.start_time.strftime('%Y-%m-%d %H:%M:%S') }}</td></tr>
                        {% endif %}
                        {% if md.end_time %}
                        <tr><td class="text-muted">End</td><td>{{ md.end_time.strftime('%Y-%m-%d %H:%M:%S') }}</td></tr>
                        {% endif %}
                        <tr><td class="text-muted">Uploaded</td><td>{{ md.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

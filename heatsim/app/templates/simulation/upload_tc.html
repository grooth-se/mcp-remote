{% extends "base.html" %}

{% block title %}Upload TC Data - {{ sim.name }}{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('simulation.index') }}">Simulations</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('simulation.view', id=sim.id) }}">{{ sim.name }}</a></li>
        <li class="breadcrumb-item active">Upload TC Data</li>
    </ol>
</nav>

<h2><i class="bi bi-thermometer-half"></i> Upload Thermocouple Data</h2>
<p class="text-muted">Upload measured temperature data from heat treatment logging to compare with simulation.</p>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-upload"></i> Upload CSV File
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="uploadForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" name="name" class="form-control" placeholder="e.g., Heat Treatment Run 1">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="2" placeholder="Optional notes about this data"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Process Step</label>
                        <select name="process_step" class="form-select">
                            <option value="heating">Heating</option>
                            <option value="quenching">Quenching</option>
                            <option value="tempering">Tempering</option>
                        </select>
                        <div class="form-text">
                            Select which process step this data corresponds to
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">TC Logger CSV File</label>
                        <input type="file" name="tc_file" id="tcFileInput" class="form-control" accept=".csv" required>
                        <div class="form-text">
                            Supported format: semicolon-separated CSV with columns: date, time, sensor, value
                        </div>
                    </div>

                    <!-- Preview area -->
                    <div id="previewArea" class="d-none mb-3">
                        <div class="card border-info">
                            <div class="card-header py-1">
                                <small><i class="bi bi-eye"></i> Preview</small>
                            </div>
                            <div class="card-body p-2">
                                <div id="previewLoading" class="text-center py-2 d-none">
                                    <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                                    <small class="ms-1">Parsing file...</small>
                                </div>
                                <div id="previewError" class="alert alert-danger py-1 mb-0 d-none"></div>
                                <div id="previewContent" class="d-none">
                                    <img id="previewPlot" class="img-fluid mb-2" alt="Preview plot">
                                    <div id="previewStats" class="small"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-upload"></i> Upload
                        </button>
                        <a href="{{ url_for('simulation.view', id=sim.id) }}" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> File Format
            </div>
            <div class="card-body">
                <p class="small">Expected CSV format (semicolon-separated):</p>
                <pre class="bg-light p-2 small">date;time;...;sensor;...;value;
2026-02-06;17:00:26;...;TC1;...;624,8;
2026-02-06;17:00:56;...;TC2;...;625,1;</pre>
                <p class="small text-muted mb-0">
                    <strong>Required columns:</strong> date, time, sensor, value<br>
                    <strong>Decimal format:</strong> European (comma) or US (period)<br>
                    <strong>Channels:</strong> Up to 8 thermocouples (TC1-TC8)
                </p>
            </div>
        </div>

        {% if existing_data %}
        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-database"></i> Existing Data
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% for data in existing_data %}
                    <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                        <div>
                            <strong>{{ data.name or 'Unnamed' }}</strong>
                            <span class="badge bg-{% if data.process_step == 'heating' %}warning text-dark{% elif data.process_step == 'quenching' %}info{% elif data.process_step == 'tempering' %}secondary{% else %}primary{% endif %} ms-1">{{ (data.process_step or 'full')|title }}</span>
                            <small class="text-muted d-block">{{ data.num_channels }} channels, {{ data.num_points }} points</small>
                        </div>
                        <form method="post" action="{{ url_for('simulation.delete_tc_data', id=sim.id, data_id=data.id) }}" class="d-inline" onsubmit="return confirm('Delete this data?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('tcFileInput');
    const previewArea = document.getElementById('previewArea');
    const previewLoading = document.getElementById('previewLoading');
    const previewError = document.getElementById('previewError');
    const previewContent = document.getElementById('previewContent');
    const previewPlot = document.getElementById('previewPlot');
    const previewStats = document.getElementById('previewStats');

    fileInput.addEventListener('change', function() {
        if (!this.files || !this.files[0]) return;

        previewArea.classList.remove('d-none');
        previewLoading.classList.remove('d-none');
        previewError.classList.add('d-none');
        previewContent.classList.add('d-none');

        const formData = new FormData();
        formData.append('tc_file', this.files[0]);
        formData.append('csrf_token', '{{ csrf_token() }}');

        fetch('{{ url_for("simulation.preview_tc_data", id=sim.id) }}', {
            method: 'POST',
            body: formData,
        })
        .then(r => r.json())
        .then(data => {
            previewLoading.classList.add('d-none');
            if (data.valid) {
                previewContent.classList.remove('d-none');
                previewPlot.src = 'data:image/png;base64,' + data.plot_base64;

                let statsHtml = '<strong>' + data.message + '</strong>';
                if (data.duration_seconds) {
                    statsHtml += ' &middot; Duration: ' + data.duration_seconds.toFixed(0) + 's';
                }
                if (data.statistics) {
                    statsHtml += '<table class="table table-sm mt-1 mb-0"><thead><tr><th>Ch</th><th>Min</th><th>Max</th><th>Avg</th></tr></thead><tbody>';
                    for (const [ch, st] of Object.entries(data.statistics)) {
                        statsHtml += '<tr><td>' + ch + '</td><td>' + st.min.toFixed(1) + '</td><td>' + st.max.toFixed(1) + '</td><td>' + st.avg.toFixed(1) + '</td></tr>';
                    }
                    statsHtml += '</tbody></table>';
                }
                previewStats.innerHTML = statsHtml;
            } else {
                previewError.classList.remove('d-none');
                previewError.textContent = data.message;
            }
        })
        .catch(err => {
            previewLoading.classList.add('d-none');
            previewError.classList.remove('d-none');
            previewError.textContent = 'Preview failed: ' + err.message;
        });
    });
});
</script>
{% endblock %}

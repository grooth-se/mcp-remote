{% extends "base.html" %}

{% block title %}Setup - {{ sim.name }}{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('simulation.index') }}">Simulations</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('simulation.view', id=sim.id) }}">{{ sim.name }}</a></li>
        <li class="breadcrumb-item active">Step 1: Geometry & Solver</li>
    </ol>
</nav>

<!-- Progress Steps -->
<div class="d-flex justify-content-center mb-4">
    <div class="d-flex align-items-center">
        <span class="badge bg-primary rounded-pill me-2">1</span>
        <span class="fw-bold text-primary">Geometry & Solver</span>
        <span class="mx-3 text-muted">→</span>
        <span class="badge bg-secondary rounded-pill me-2">2</span>
        <span class="text-muted">Heat Treatment</span>
        <span class="mx-3 text-muted">→</span>
        <span class="badge bg-secondary rounded-pill me-2">3</span>
        <span class="text-muted">Run Simulation</span>
    </div>
</div>

<h2>Configure Simulation: {{ sim.name }}</h2>
<p class="text-muted">{{ sim.steel_grade.designation }} | {{ sim.geometry_label }}</p>

<form method="post">
    {{ geometry_form.hidden_tag() }}

    <div class="row">
        <!-- Geometry Configuration -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-box"></i> Geometry ({{ sim.geometry_label }})
                </div>
                <div class="card-body">
                    {% if sim.geometry_type == 'cad' and cad_analysis %}
                    <!-- CAD Analysis Display -->
                    <div class="alert alert-info py-2 mb-3">
                        <small><i class="bi bi-file-earmark-code"></i> <strong>Source:</strong> {{ cad_analysis.filename }}</small>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label text-muted small">Volume</label>
                            <p class="fw-bold mb-0">{{ "%.6f"|format(cad_analysis.volume * 1e6) }} cm<sup>3</sup></p>
                        </div>
                        <div class="col-6">
                            <label class="form-label text-muted small">Surface Area</label>
                            <p class="fw-bold mb-0">{{ "%.4f"|format(cad_analysis.surface_area * 1e4) }} cm<sup>2</sup></p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label text-muted small">Characteristic Length (V/A)</label>
                            <p class="fw-bold mb-0">{{ "%.3f"|format(cad_analysis.characteristic_length * 1000) }} mm</p>
                        </div>
                        <div class="col-6">
                            <label class="form-label text-muted small">Bounding Box</label>
                            <p class="fw-bold mb-0">
                                {{ "%.1f"|format(cad_analysis.bounding_box[0] * 1000) }} x
                                {{ "%.1f"|format(cad_analysis.bounding_box[1] * 1000) }} x
                                {{ "%.1f"|format(cad_analysis.bounding_box[2] * 1000) }} mm
                            </p>
                        </div>
                    </div>

                    <hr>
                    <h6><i class="bi bi-arrow-repeat"></i> Equivalent {{ cad_analysis.equivalent_type|title }} Geometry</h6>
                    <div class="row">
                        {% if cad_analysis.equivalent_type == 'cylinder' %}
                        <div class="col-6">
                            <label class="form-label text-muted small">Radius</label>
                            <p class="fw-bold mb-0">{{ "%.2f"|format(cad_analysis.equivalent_params.radius * 1000) }} mm</p>
                        </div>
                        <div class="col-6">
                            <label class="form-label text-muted small">Length</label>
                            <p class="fw-bold mb-0">{{ "%.2f"|format(cad_analysis.equivalent_params.length * 1000) }} mm</p>
                        </div>
                        {% else %}
                        <div class="col-4">
                            <label class="form-label text-muted small">Thickness</label>
                            <p class="fw-bold mb-0">{{ "%.2f"|format(cad_analysis.equivalent_params.thickness * 1000) }} mm</p>
                        </div>
                        <div class="col-4">
                            <label class="form-label text-muted small">Width</label>
                            <p class="fw-bold mb-0">{{ "%.1f"|format(cad_analysis.equivalent_params.width * 1000) }} mm</p>
                        </div>
                        <div class="col-4">
                            <label class="form-label text-muted small">Length</label>
                            <p class="fw-bold mb-0">{{ "%.1f"|format(cad_analysis.equivalent_params.length * 1000) }} mm</p>
                        </div>
                        {% endif %}
                    </div>

                    <div class="alert alert-secondary py-2 mt-3 mb-0">
                        <small>
                            <i class="bi bi-info-circle"></i>
                            The 1D simulation uses this equivalent geometry to approximate the thermal behavior
                            of the actual CAD model. The characteristic length L<sub>c</sub> = V/A determines
                            the thermal response.
                        </small>
                    </div>

                    {% elif sim.geometry_type == 'cylinder' %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Radius (mm)</label>
                            <input type="number" name="radius" class="form-control" step="0.1" min="1" max="1500" value="{{ geometry_form.radius.data or 50 }}">
                            <div class="form-text">Supports up to 1200mm diameter</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Length (mm)</label>
                            <input type="number" name="length" class="form-control" step="0.1" min="1" max="5000" value="{{ geometry_form.length.data or 100 }}">
                        </div>
                    </div>
                    <div class="text-center py-3 bg-light rounded">
                        <svg width="120" height="100" viewBox="0 0 120 100">
                            <!-- Cylinder side view -->
                            <ellipse cx="60" cy="85" rx="45" ry="12" fill="none" stroke="#0d6efd" stroke-width="2"/>
                            <line x1="15" y1="85" x2="15" y2="25" stroke="#0d6efd" stroke-width="2"/>
                            <line x1="105" y1="85" x2="105" y2="25" stroke="#0d6efd" stroke-width="2"/>
                            <ellipse cx="60" cy="25" rx="45" ry="12" fill="none" stroke="#0d6efd" stroke-width="2"/>
                            <!-- Radius arrow -->
                            <line x1="60" y1="55" x2="105" y2="55" stroke="#dc3545" stroke-width="1" stroke-dasharray="3,3"/>
                            <text x="82" y="50" text-anchor="middle" font-size="10" fill="#dc3545">R</text>
                        </svg>
                        <div class="small text-muted mt-1">1D radial heat transfer (center to surface)</div>
                    </div>

                    {% elif sim.geometry_type == 'plate' %}
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Thickness (mm)</label>
                            <input type="number" name="thickness" class="form-control" step="0.1" min="1" max="1500" value="{{ geometry_form.thickness.data or 20 }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Width (mm)</label>
                            <input type="number" name="width" class="form-control" step="0.1" min="1" max="5000" value="{{ geometry_form.width.data or 100 }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Length (mm)</label>
                            <input type="number" name="length" class="form-control" step="0.1" min="1" max="5000" value="{{ geometry_form.length.data or 100 }}">
                        </div>
                    </div>
                    <div class="text-center py-3 bg-light rounded">
                        <svg width="120" height="80" viewBox="0 0 120 80">
                            <!-- Plate cross section -->
                            <rect x="10" y="25" width="100" height="30" fill="none" stroke="#0d6efd" stroke-width="2"/>
                            <line x1="60" y1="25" x2="60" y2="55" stroke="#dc3545" stroke-width="1" stroke-dasharray="3,3"/>
                            <text x="70" y="42" text-anchor="start" font-size="10" fill="#dc3545">t/2</text>
                        </svg>
                        <div class="small text-muted mt-1">1D through-thickness heat transfer (symmetric)</div>
                    </div>

                    {% elif sim.geometry_type == 'hollow_cylinder' %}
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Outer Diameter OD (mm)</label>
                            <input type="number" name="outer_diameter" class="form-control" step="0.1" min="2" max="3000" value="{{ geometry_form.outer_diameter.data or 100 }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Inner Diameter ID (mm)</label>
                            <input type="number" name="inner_diameter" class="form-control" step="0.1" min="1" max="2990" value="{{ geometry_form.inner_diameter.data or 40 }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Length (mm)</label>
                            <input type="number" name="length" class="form-control" step="0.1" min="1" max="5000" value="{{ geometry_form.length.data or 100 }}">
                        </div>
                    </div>
                    <div class="text-center py-3 bg-light rounded">
                        <svg width="120" height="100" viewBox="0 0 120 100">
                            <!-- Hollow cylinder cross section -->
                            <circle cx="60" cy="50" r="40" fill="none" stroke="#0d6efd" stroke-width="2"/>
                            <circle cx="60" cy="50" r="16" fill="white" stroke="#0d6efd" stroke-width="2"/>
                            <!-- OD arrow -->
                            <line x1="20" y1="50" x2="100" y2="50" stroke="#dc3545" stroke-width="1" stroke-dasharray="3,3"/>
                            <text x="60" y="45" text-anchor="middle" font-size="9" fill="#dc3545">OD</text>
                            <!-- ID arrow -->
                            <line x1="44" y1="65" x2="76" y2="65" stroke="#198754" stroke-width="1" stroke-dasharray="3,3"/>
                            <text x="60" y="75" text-anchor="middle" font-size="9" fill="#198754">ID</text>
                        </svg>
                        <div class="small text-muted mt-1">1D radial heat transfer (ID to OD)</div>
                    </div>

                    {% else %}
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Inner Radius (mm)</label>
                            <input type="number" name="inner_radius" class="form-control" step="0.1" min="1" max="1500" value="{{ geometry_form.inner_radius.data or 20 }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Outer Radius (mm)</label>
                            <input type="number" name="outer_radius" class="form-control" step="0.1" min="1" max="1500" value="{{ geometry_form.outer_radius.data or 50 }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Length (mm)</label>
                            <input type="number" name="length" class="form-control" step="0.1" min="1" max="5000" value="{{ geometry_form.length.data or 100 }}">
                        </div>
                    </div>
                    <div class="text-center py-3 bg-light rounded">
                        <svg width="120" height="100" viewBox="0 0 120 100">
                            <!-- Ring cross section -->
                            <circle cx="60" cy="50" r="40" fill="none" stroke="#0d6efd" stroke-width="2"/>
                            <circle cx="60" cy="50" r="20" fill="white" stroke="#0d6efd" stroke-width="2"/>
                            <line x1="60" y1="50" x2="100" y2="50" stroke="#dc3545" stroke-width="1" stroke-dasharray="3,3"/>
                            <text x="80" y="45" text-anchor="middle" font-size="9" fill="#dc3545">Ro</text>
                            <line x1="60" y1="50" x2="80" y2="50" stroke="#198754" stroke-width="1" stroke-dasharray="3,3"/>
                            <text x="70" y="60" text-anchor="middle" font-size="9" fill="#198754">Ri</text>
                        </svg>
                        <div class="small text-muted mt-1">1D radial heat transfer (inner to outer)</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Solver Settings -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-gear"></i> Solver Settings
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Solver Type</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="solver_type" id="solver-builtin" value="builtin"
                                       {% if not solver_form.solver_type.data or solver_form.solver_type.data == 'builtin' %}checked{% endif %}
                                       onchange="toggleSolverOptions()">
                                <label class="form-check-label" for="solver-builtin">
                                    <i class="bi bi-calculator"></i> Built-in 1D FDM
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="solver_type" id="solver-comsol" value="comsol"
                                       {% if solver_form.solver_type.data == 'comsol' %}checked{% endif %}
                                       onchange="toggleSolverOptions()">
                                <label class="form-check-label" for="solver-comsol">
                                    <i class="bi bi-gpu-card"></i> COMSOL 3D FEM
                                </label>
                            </div>
                        </div>
                        <div class="form-text">COMSOL 3D produces VTK temperature fields; falls back to mock if COMSOL not installed.</div>
                    </div>

                    <div id="builtin-solver-options">
                    <div class="mb-3">
                        <label class="form-label">Number of Nodes</label>
                        <input type="number" name="n_nodes" class="form-control" step="2" min="11" max="201" value="{{ solver_form.n_nodes.data or 51 }}">
                        <div class="form-text">Spatial discretization points (odd number recommended)</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Maximum Time (s)</label>
                        <input type="number" name="max_time" class="form-control" step="60" min="10" max="180000" value="{{ solver_form.max_time.data or 1800 }}" id="max-time-input">
                        <div class="form-text">Total simulation time limit (up to 50 hours for large parts)</div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" name="auto_dt" class="form-check-input" id="auto-dt-checkbox" {% if solver_form.auto_dt.data %}checked{% endif %}>
                            <label class="form-check-label" for="auto-dt-checkbox">
                                Auto-calculate time step (~20,000 steps)
                            </label>
                        </div>
                        <div class="form-text">Automatically sets dt = max_time / 20,000</div>
                    </div>

                    <div class="mb-3" id="dt-input-group">
                        <label class="form-label">Time Step (s)</label>
                        <input type="number" name="dt" class="form-control" step="0.1" min="0.001" max="60" value="{{ solver_form.dt.data or 0.1 }}" id="dt-input">
                        <div class="form-text">Calculated: <span id="calculated-dt">-</span> s | Estimated steps: <span id="estimated-steps">-</span></div>
                    </div>

                    <div class="alert alert-info mt-3 mb-0" id="builtin-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Crank-Nicolson Scheme</strong><br>
                        <small>Uses implicit finite differences for stability with temperature-dependent properties.</small>
                    </div>
                    </div><!-- end builtin-solver-options -->

                    <div id="comsol-solver-options" style="display:none;">
                        <div class="alert alert-primary mb-0">
                            <i class="bi bi-gpu-card"></i>
                            <strong>COMSOL 3D FEM Solver</strong><br>
                            <small>Solves the full 3D heat equation using COMSOL Multiphysics. Generates VTK temperature fields
                            for 3D visualization. If COMSOL is not installed, a mock solver produces realistic synthetic VTK data
                            with PyVista meshes.</small>
                        </div>
                    </div>
                </div>
                <script>
                function updateDtCalculation() {
                    const maxTime = parseFloat(document.getElementById('max-time-input').value) || 1800;
                    const autoDt = document.getElementById('auto-dt-checkbox').checked;
                    const dtInput = document.getElementById('dt-input');
                    const dtInputGroup = document.getElementById('dt-input-group');

                    const calculatedDt = Math.max(0.1, maxTime / 20000);
                    document.getElementById('calculated-dt').textContent = calculatedDt.toFixed(2);

                    if (autoDt) {
                        dtInput.value = calculatedDt.toFixed(2);
                        dtInput.disabled = true;
                        dtInputGroup.style.opacity = '0.6';
                    } else {
                        dtInput.disabled = false;
                        dtInputGroup.style.opacity = '1';
                    }

                    const dt = parseFloat(dtInput.value) || 0.1;
                    const steps = Math.ceil(maxTime / dt);
                    document.getElementById('estimated-steps').textContent = steps.toLocaleString();
                }

                document.getElementById('max-time-input').addEventListener('input', updateDtCalculation);
                document.getElementById('auto-dt-checkbox').addEventListener('change', updateDtCalculation);
                document.getElementById('dt-input').addEventListener('input', function() {
                    const maxTime = parseFloat(document.getElementById('max-time-input').value) || 1800;
                    const dt = parseFloat(this.value) || 0.1;
                    const steps = Math.ceil(maxTime / dt);
                    document.getElementById('estimated-steps').textContent = steps.toLocaleString();
                });

                updateDtCalculation();

                function toggleSolverOptions() {
                    const isComsol = document.getElementById('solver-comsol').checked;
                    document.getElementById('builtin-solver-options').style.display = isComsol ? 'none' : 'block';
                    document.getElementById('comsol-solver-options').style.display = isComsol ? 'block' : 'none';
                    // Disable hidden inputs so browser skips their validation
                    document.querySelectorAll('#builtin-solver-options input').forEach(function(el) {
                        el.disabled = isComsol;
                    });
                }
                toggleSolverOptions();
                </script>
            </div>
        </div>
    </div>

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-arrow-right"></i> Next: Heat Treatment Setup
        </button>
        <a href="{{ url_for('simulation.view', id=sim.id) }}" class="btn btn-outline-secondary">Cancel</a>
    </div>
</form>
{% endblock %}

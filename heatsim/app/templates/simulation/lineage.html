{% extends "base.html" %}

{% block title %}Lineage - {{ sim.name }}{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('simulation.index') }}">Simulations</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('simulation.view', id=sim.id) }}">{{ sim.name }}</a></li>
        <li class="breadcrumb-item active">Lineage v{{ snapshot.version }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>
        <i class="bi bi-diagram-3"></i> Data Lineage
        <span class="badge bg-info fs-6">v{{ snapshot.version }}</span>
        {% if drifts %}
        <span class="badge bg-warning fs-6" title="{{ drifts|length }} field(s) changed since run">
            <i class="bi bi-exclamation-triangle"></i> Drift
        </span>
        {% else %}
        <span class="badge bg-success fs-6" title="Frozen data matches current database">
            <i class="bi bi-check-circle"></i> No Drift
        </span>
        {% endif %}
    </h2>
    <div>
        <a href="{{ url_for('simulation.compliance_report', id=sim.id, version=snapshot.version) }}"
           class="btn btn-primary btn-sm">
            <i class="bi bi-file-earmark-word"></i> Compliance Report
        </a>
        <a href="{{ url_for('simulation.view', id=sim.id) }}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>
</div>

<!-- Lineage Tree -->
<div class="lineage-tree">
    <!-- Level 1: Material Source -->
    <div class="card border-primary mb-3">
        <div class="card-header bg-primary text-white">
            <i class="bi bi-database"></i> Material: {{ lineage.material.designation }}
            <small class="ms-2">({{ lineage.material.data_source or 'N/A' }})</small>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- Composition -->
                <div class="col-md-4">
                    <div class="card h-100 {{ 'border-warning' if drifts|selectattr('field', 'match', 'Composition.*')|list else 'border-success' }}">
                        <div class="card-header py-1">
                            {% set comp_drifts = drifts|selectattr('field', 'match', 'Composition.*')|list %}
                            {% if comp_drifts %}
                            <i class="bi bi-exclamation-triangle text-warning"></i>
                            {% else %}
                            <i class="bi bi-check-circle text-success"></i>
                            {% endif %}
                            Composition
                        </div>
                        <div class="card-body py-2">
                            {% set comp = lineage.material.composition %}
                            {% if comp %}
                            <table class="table table-sm mb-0">
                                <tbody>
                                    {% for elem in ['carbon', 'manganese', 'silicon', 'chromium', 'nickel', 'molybdenum'] %}
                                    {% if comp.get(elem) %}
                                    <tr>
                                        <td class="text-muted small">{{ elem|title }}</td>
                                        <td class="small">{{ '%.4f'|format(comp[elem]) }}%</td>
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <small class="text-muted">No composition data</small>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Properties -->
                <div class="col-md-4">
                    <div class="card h-100 {{ 'border-warning' if drifts|selectattr('field', 'equalto', 'Material Properties Count')|list else 'border-success' }}">
                        <div class="card-header py-1">
                            {% set prop_drifts = drifts|selectattr('field', 'equalto', 'Material Properties Count')|list %}
                            {% if prop_drifts %}
                            <i class="bi bi-exclamation-triangle text-warning"></i>
                            {% else %}
                            <i class="bi bi-check-circle text-success"></i>
                            {% endif %}
                            Properties ({{ lineage.material.properties_count }})
                        </div>
                        <div class="card-body py-2">
                            {% for p in lineage.material.properties %}
                            <div class="small">
                                <span class="badge bg-secondary">{{ p.type }}</span>
                                {{ p.name }}
                                {% if p.units %}<small class="text-muted">({{ p.units }})</small>{% endif %}
                            </div>
                            {% endfor %}
                            {% if not lineage.material.properties %}
                            <small class="text-muted">No properties</small>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Phase Diagram -->
                <div class="col-md-4">
                    <div class="card h-100 {{ 'border-warning' if drifts|selectattr('field', 'match', 'Phase Diagram.*')|list else 'border-success' }}">
                        <div class="card-header py-1">
                            {% set pd_drifts = drifts|selectattr('field', 'match', 'Phase Diagram.*')|list %}
                            {% if pd_drifts %}
                            <i class="bi bi-exclamation-triangle text-warning"></i>
                            {% else %}
                            <i class="bi bi-check-circle text-success"></i>
                            {% endif %}
                            Phase Diagram
                        </div>
                        <div class="card-body py-2">
                            {% set pd = lineage.material.phase_diagram %}
                            {% if pd and pd.get('transformation_temps') %}
                            <table class="table table-sm mb-0">
                                <tbody>
                                    {% for key, val in pd.transformation_temps.items() %}
                                    <tr>
                                        <td class="text-muted small">{{ key }}</td>
                                        <td class="small">{{ val }} Â°C</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <small class="text-muted">No phase diagram</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Connector -->
    <div class="text-center mb-3">
        <i class="bi bi-arrow-down fs-3 text-muted"></i>
    </div>

    <!-- Level 2: Simulation Config -->
    <div class="card border-info mb-3">
        <div class="card-header bg-info text-white">
            <i class="bi bi-gear"></i> Simulation Config
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <h6 class="text-muted small">Geometry</h6>
                    <p class="mb-1"><strong>{{ lineage.config.geometry_type }}</strong></p>
                    {% if lineage.config.cad_filename %}
                    <small class="text-muted">CAD: {{ lineage.config.cad_filename }}</small>
                    {% endif %}
                    {% for key, val in lineage.config.geometry.items() %}
                    <div class="small text-muted">{{ key }}: {{ '%.4f m'|format(val) if val is number else val }}</div>
                    {% endfor %}
                </div>
                <div class="col-md-4">
                    <h6 class="text-muted small">Heat Treatment</h6>
                    {% set ht = lineage.config.heat_treatment %}
                    {% if ht %}
                    {% for phase_name in ['heating', 'transfer', 'quenching', 'tempering'] %}
                    {% set phase = ht.get(phase_name, {}) %}
                    {% if phase.get('enabled', False) %}
                    <div class="small mb-1">
                        <span class="badge bg-secondary">{{ phase_name }}</span>
                        {% for key, val in phase.items() %}
                        {% if key != 'enabled' %}
                        <span class="text-muted">{{ key.replace('_', ' ') }}: {{ val }}</span>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    <small class="text-muted">No heat treatment config</small>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <h6 class="text-muted small">Solver</h6>
                    {% set solver = lineage.config.solver %}
                    {% if solver %}
                    {% for key, val in solver.items() %}
                    <div class="small text-muted">{{ key.replace('_', ' ').title() }}: {{ val }}</div>
                    {% endfor %}
                    {% else %}
                    <small class="text-muted">No solver config</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Connector -->
    <div class="text-center mb-3">
        <i class="bi bi-arrow-down fs-3 text-muted"></i>
    </div>

    <!-- Level 3: Results -->
    <div class="card border-success mb-3">
        <div class="card-header bg-success text-white">
            <i class="bi bi-graph-up"></i> Results
            <span class="badge bg-light text-dark ms-2">{{ lineage.results.status }}</span>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <small class="text-muted">Duration</small>
                    <div class="fw-bold">{{ '%.1f s'|format(lineage.results.duration) if lineage.results.duration else '-' }}</div>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">t8/5</small>
                    <div class="fw-bold">{{ '%.2f s'|format(lineage.results.t_800_500) if lineage.results.t_800_500 else '-' }}</div>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">Surface Hardness</small>
                    <div class="fw-bold">{{ '%.0f HV'|format(lineage.results.hardness_surface) if lineage.results.hardness_surface else '-' }}</div>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">Center Hardness</small>
                    <div class="fw-bold">{{ '%.0f HV'|format(lineage.results.hardness_center) if lineage.results.hardness_center else '-' }}</div>
                </div>
            </div>
            {% if lineage.results.result_types %}
            <div class="mt-2">
                <small class="text-muted">Result Types:</small>
                {% for rtype, count in lineage.results.result_types.items() %}
                <span class="badge bg-outline-secondary border">{{ rtype }} ({{ count }})</span>
                {% endfor %}
                <small class="text-muted ms-2">({{ lineage.results.total_results }} total)</small>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Drift Details -->
{% if drifts %}
<div class="card border-warning mt-4">
    <div class="card-header bg-warning">
        <i class="bi bi-exclamation-triangle"></i> Material Drift Detected ({{ drifts|length }} field(s))
    </div>
    <div class="card-body p-0">
        <table class="table table-sm mb-0">
            <thead class="table-light">
                <tr>
                    <th>Field</th>
                    <th>At Run Time</th>
                    <th>Current Value</th>
                </tr>
            </thead>
            <tbody>
                {% for d in drifts %}
                <tr>
                    <td class="fw-bold">{{ d.field }}</td>
                    <td><span class="text-danger">{{ d.snapshot_value if d.snapshot_value is not none else '-' }}</span></td>
                    <td><span class="text-success">{{ d.current_value if d.current_value is not none else '-' }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endblock %}

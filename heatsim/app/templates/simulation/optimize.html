{% extends "base.html" %}

{% block title %}Process Optimization - {{ sim.name }}{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('simulation.index') }}">Simulations</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('simulation.view', id=sim.id) }}">{{ sim.name }}</a></li>
        <li class="breadcrumb-item active">Process Optimization</li>
    </ol>
</nav>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bullseye"></i> Process Optimization</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Automatically find optimal heat treatment parameters to achieve a target outcome.
                    Uses iterative optimization with reduced-resolution simulations for fast evaluation.
                </p>

                <form method="post" id="optimizeForm">
                    {{ form.hidden_tag() }}

                    <!-- Objective -->
                    <div class="card mb-3">
                        <div class="card-header py-2"><strong>Objective</strong></div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Output to Optimize</label>
                                        {{ form.objective_output(class="form-select") }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Direction</label>
                                        {{ form.objective_direction(class="form-select") }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3" id="targetValueGroup">
                                        <label class="form-label">Target Value</label>
                                        {{ form.target_value(class="form-control", placeholder="e.g., 350") }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Parameters -->
                    <div class="card mb-3">
                        <div class="card-header py-2"><strong>Parameters to Vary</strong></div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;"></th>
                                            <th>Parameter</th>
                                            <th>Min</th>
                                            <th>Max</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>{{ form.opt_aust_temp(class="form-check-input") }}</td>
                                            <td><label for="opt_aust_temp">Austenitizing Temperature (°C)</label></td>
                                            <td>{{ form.opt_aust_temp_min(class="form-control form-control-sm", style="width:100px") }}</td>
                                            <td>{{ form.opt_aust_temp_max(class="form-control form-control-sm", style="width:100px") }}</td>
                                        </tr>
                                        <tr>
                                            <td>{{ form.opt_quench_temp(class="form-check-input") }}</td>
                                            <td><label for="opt_quench_temp">Quench Media Temperature (°C)</label></td>
                                            <td>{{ form.opt_quench_temp_min(class="form-control form-control-sm", style="width:100px") }}</td>
                                            <td>{{ form.opt_quench_temp_max(class="form-control form-control-sm", style="width:100px") }}</td>
                                        </tr>
                                        <tr>
                                            <td>{{ form.opt_quench_duration(class="form-check-input") }}</td>
                                            <td><label for="opt_quench_duration">Quench Duration (s)</label></td>
                                            <td>{{ form.opt_quench_duration_min(class="form-control form-control-sm", style="width:100px") }}</td>
                                            <td>{{ form.opt_quench_duration_max(class="form-control form-control-sm", style="width:100px") }}</td>
                                        </tr>
                                        {% set ht = sim.ht_config %}
                                        {% if ht and ht.tempering and ht.tempering.enabled %}
                                        <tr>
                                            <td>{{ form.opt_temper_temp(class="form-check-input") }}</td>
                                            <td><label for="opt_temper_temp">Tempering Temperature (°C)</label></td>
                                            <td>{{ form.opt_temper_temp_min(class="form-control form-control-sm", style="width:100px") }}</td>
                                            <td>{{ form.opt_temper_temp_max(class="form-control form-control-sm", style="width:100px") }}</td>
                                        </tr>
                                        <tr>
                                            <td>{{ form.opt_temper_hold(class="form-check-input") }}</td>
                                            <td><label for="opt_temper_hold">Tempering Hold Time (min)</label></td>
                                            <td>{{ form.opt_temper_hold_min(class="form-control form-control-sm", style="width:100px") }}</td>
                                            <td>{{ form.opt_temper_hold_max(class="form-control form-control-sm", style="width:100px") }}</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Constraint (collapsible) -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <div class="form-check mb-0">
                                {{ form.constraint_enabled(class="form-check-input") }}
                                <label class="form-check-label" for="constraint_enabled"><strong>Output Constraint</strong></label>
                            </div>
                        </div>
                        <div class="card-body" id="constraintSection" style="display:none;">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Output</label>
                                    {{ form.constraint_output(class="form-select form-select-sm") }}
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Operator</label>
                                    {{ form.constraint_operator(class="form-select form-select-sm") }}
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Value</label>
                                    {{ form.constraint_value(class="form-control form-control-sm", placeholder="e.g., 20") }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Optimization Method</label>
                            {{ form.method(class="form-select") }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Max Iterations</label>
                            {{ form.max_iterations(class="form-control") }}
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="form-check">
                                {{ form.create_best_sim(class="form-check-input") }}
                                <label class="form-check-label" for="create_best_sim">
                                    Create simulation with best parameters
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success" id="runBtn">
                            <i class="bi bi-play-fill"></i> Run Optimization
                        </button>
                        <a href="{{ url_for('simulation.view', id=sim.id) }}" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Base Simulation</h6>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-5">Name</dt>
                    <dd class="col-7">{{ sim.name }}</dd>

                    <dt class="col-5">Steel Grade</dt>
                    <dd class="col-7">{{ sim.steel_grade.designation }}</dd>

                    <dt class="col-5">Geometry</dt>
                    <dd class="col-7">{{ sim.geometry_label }}</dd>

                    {% set ht = sim.ht_config %}
                    {% if ht %}
                    <dt class="col-5">Austenitizing</dt>
                    <dd class="col-7">{{ ht.heating.target_temperature|default(850) }}°C</dd>

                    <dt class="col-5">Quench Media</dt>
                    <dd class="col-7">{{ ht.quenching.media|default('water')|title }} @ {{ ht.quenching.media_temperature|default(25) }}°C</dd>

                    {% if ht.tempering and ht.tempering.enabled %}
                    <dt class="col-5">Tempering</dt>
                    <dd class="col-7">{{ ht.tempering.temperature|default(550) }}°C</dd>
                    {% endif %}
                    {% endif %}
                </dl>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-lightbulb"></i> Tips</h6>
            </div>
            <div class="card-body small">
                <ul class="mb-0">
                    <li><strong>Nelder-Mead</strong>: Fast local search, best for 1-3 parameters</li>
                    <li><strong>Differential Evolution</strong>: Global search, better for 3+ parameters</li>
                    <li>Target mode: finds parameters achieving exact value (e.g., 350 HV)</li>
                    <li>Use constraints for secondary requirements (e.g., t₈/₅ &lt; 20s)</li>
                    <li>Each evaluation takes ~0.5s (31-node reduced resolution)</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle target value visibility
    const dirSelect = document.getElementById('objective_direction');
    const targetGroup = document.getElementById('targetValueGroup');
    function toggleTarget() {
        targetGroup.style.display = dirSelect.value === 'target' ? '' : 'none';
    }
    dirSelect.addEventListener('change', toggleTarget);
    toggleTarget();

    // Toggle constraint section
    const constraintCheck = document.getElementById('constraint_enabled');
    const constraintSection = document.getElementById('constraintSection');
    function toggleConstraint() {
        constraintSection.style.display = constraintCheck.checked ? '' : 'none';
    }
    constraintCheck.addEventListener('change', toggleConstraint);
    toggleConstraint();

    // Submit spinner
    document.getElementById('optimizeForm').addEventListener('submit', function() {
        const btn = document.getElementById('runBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Optimizing...';
    });
});
</script>
{% endblock %}

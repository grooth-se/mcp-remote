{% extends "base.html" %}

{% block title %}{{ sim.name }}{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('simulation.index') }}">Simulations</a></li>
        <li class="breadcrumb-item active">{{ sim.name }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-2">
    <div>
        <h2 class="mb-0">
            {{ sim.name }}
            <span class="badge {{ sim.status_badge_class }}">{{ sim.status }}</span>
        </h2>
        {% if sim.description %}
        <small class="text-muted">{{ sim.description }}</small>
        {% endif %}
    </div>
    <div>
        <a href="{{ url_for('simulation.setup', id=sim.id) }}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-box"></i> Geometry
        </a>
        <a href="{{ url_for('simulation.heat_treatment', id=sim.id) }}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-thermometer"></i> Heat Treatment
        </a>
        <a href="{{ url_for('simulation.upload_tc_data', id=sim.id) }}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-upload"></i> Upload TC Data
        </a>
        {% if sim.status in ['ready', 'completed', 'failed'] %}
        <form method="post" action="{{ url_for('simulation.run', id=sim.id) }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-success btn-sm">
                <i class="bi bi-play-fill"></i> Run
            </button>
        </form>
        {% endif %}
        <form method="post" action="{{ url_for('simulation.delete', id=sim.id) }}" class="d-inline" onsubmit="return confirm('Delete this simulation?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-trash"></i>
            </button>
        </form>
    </div>
</div>

{% if sim.error_message %}
<div class="alert alert-danger py-1">
    <strong>Error:</strong> {{ sim.error_message }}
</div>
{% endif %}

<!-- Simulation Info - Compact Row -->
<div class="sim-info-row">
    <div class="card">
        <div class="card-body">
            <h6 class="text-muted">Steel Grade</h6>
            <p class="fw-bold">{{ sim.steel_grade.designation }}</p>
            <small class="text-muted">{{ sim.steel_grade.data_source }}</small>
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <h6 class="text-muted">Geometry</h6>
            <p class="fw-bold">{{ sim.geometry_label }}</p>
            {% set geom = sim.geometry_dict %}
            <small class="text-muted">
                {% if sim.geometry_type == 'cylinder' %}
                R={{ (geom.radius * 1000)|round(1) }}mm
                {% elif sim.geometry_type == 'plate' %}
                t={{ (geom.thickness * 1000)|round(1) }}mm
                {% else %}
                Ri={{ (geom.inner_radius * 1000)|round(1) }}, Ro={{ (geom.outer_radius * 1000)|round(1) }}mm
                {% endif %}
            </small>
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <h6 class="text-muted">Heat Treatment</h6>
            {% set phase_summary = sim.get_phases_summary() %}
            {% if phase_summary %}
                {% for p in phase_summary[:2] %}
                <small class="d-block">{{ p }}</small>
                {% endfor %}
                {% if phase_summary|length > 2 %}
                <small class="text-muted">+{{ phase_summary|length - 2 }} more...</small>
                {% endif %}
            {% else %}
            <p class="text-muted mb-0">Not configured</p>
            {% endif %}
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <h6 class="text-muted">Duration</h6>
            {% if sim.duration_seconds %}
            <p class="fw-bold">{{ sim.duration_seconds|round(1) }} s</p>
            <small class="text-muted">{{ sim.completed_at.strftime('%Y-%m-%d %H:%M') }}</small>
            {% else %}
            <p class="text-muted mb-0">Not run yet</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Results -->
{% if results %}
<h4><i class="bi bi-graph-up"></i> Results</h4>

<!-- Full Cycle Plot (Simulation) -->
{% if cooling_curves %}
<div class="plot-full-width">
    {% for result in cooling_curves %}
    <div class="card">
        <div class="card-header">
            <i class="bi bi-graph-up-arrow"></i> {{ result.result_label }} (Simulation)
            {% if result.phase and result.phase != 'full' %}
            <span class="badge bg-secondary">{{ result.phase|title }}</span>
            {% endif %}
            {% if result.t_800_500 %}
            <span class="badge bg-info float-end">t₈/₅ = {{ result.t_800_500|round(2) }} s</span>
            {% endif %}
        </div>
        <div class="card-body text-center">
            {% if result.has_plot %}
            <img src="{{ url_for('simulation.result_image', id=sim.id, result_id=result.id) }}" class="img-fluid" alt="{{ result.result_label }}">
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Measured TC Data -->
{% if measured_data %}
<h4 class="mt-4"><i class="bi bi-thermometer-half"></i> Measured TC Data</h4>
<div class="plot-full-width">
    <div class="card">
        <div class="card-header">
            <i class="bi bi-graph-up-arrow"></i> Temperature vs Time (Measured)
            {% for data in measured_data %}
            <span class="badge bg-secondary ms-1">{{ data.name }}</span>
            {% endfor %}
            <a href="{{ url_for('simulation.upload_tc_data', id=sim.id) }}" class="btn btn-sm btn-outline-primary float-end">
                <i class="bi bi-gear"></i> Manage
            </a>
        </div>
        <div class="card-body text-center">
            <img src="{{ url_for('simulation.measured_tc_plot', id=sim.id) }}" class="img-fluid" alt="Measured TC Data">
        </div>
    </div>
</div>

<!-- Measured dT/dt Plots -->
<h5><i class="bi bi-activity"></i> Measured Rates</h5>
<div class="plot-grid">
    <div class="card">
        <div class="card-header">
            <i class="bi bi-activity"></i> dT/dt vs Time (Measured)
        </div>
        <div class="card-body text-center">
            <img src="{{ url_for('simulation.measured_dtdt_plot', id=sim.id) }}" class="img-fluid" alt="Measured dT/dt vs Time">
        </div>
    </div>
    <div class="card">
        <div class="card-header">
            <i class="bi bi-graph-down"></i> dT/dt vs Temperature (Measured)
        </div>
        <div class="card-body text-center">
            <img src="{{ url_for('simulation.measured_dtdt_temp_plot', id=sim.id) }}" class="img-fluid" alt="Measured dT/dt vs Temp">
        </div>
    </div>
</div>
{% endif %}

<!-- dT/dt vs Time Plots - 3 columns -->
{% if dtdt_time_heating or dtdt_time_quenching %}
<h5><i class="bi bi-activity"></i> Rates vs Time</h5>
<div class="plot-grid">
    {% for result in dtdt_time_heating %}
    <div class="card">
        <div class="card-header">
            {{ result.result_label }}
            <span class="badge bg-warning text-dark">Heating</span>
        </div>
        <div class="card-body text-center">
            {% if result.has_plot %}
            <img src="{{ url_for('simulation.result_image', id=sim.id, result_id=result.id) }}" alt="{{ result.result_label }}">
            {% endif %}
        </div>
    </div>
    {% endfor %}
    {% for result in dtdt_time_quenching %}
    <div class="card">
        <div class="card-header">
            {{ result.result_label }}
            <span class="badge bg-info">Quenching</span>
        </div>
        <div class="card-body text-center">
            {% if result.has_plot %}
            <img src="{{ url_for('simulation.result_image', id=sim.id, result_id=result.id) }}" alt="{{ result.result_label }}">
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- dT/dt vs Temperature Plots - 3 columns -->
{% if dtdt_temp_heating or dtdt_temp_quenching %}
<h5><i class="bi bi-graph-down"></i> Rates vs Temperature</h5>
<div class="plot-grid">
    {% for result in dtdt_temp_heating %}
    <div class="card">
        <div class="card-header">
            {{ result.result_label }}
            <span class="badge bg-warning text-dark">Heating</span>
        </div>
        <div class="card-body text-center">
            {% if result.has_plot %}
            <img src="{{ url_for('simulation.result_image', id=sim.id, result_id=result.id) }}" alt="{{ result.result_label }}">
            {% endif %}
        </div>
    </div>
    {% endfor %}
    {% for result in dtdt_temp_quenching %}
    <div class="card">
        <div class="card-header">
            {{ result.result_label }}
            <span class="badge bg-info">Quenching</span>
        </div>
        <div class="card-body text-center">
            {% if result.has_plot %}
            <img src="{{ url_for('simulation.result_image', id=sim.id, result_id=result.id) }}" alt="{{ result.result_label }}">
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Other Results - 3 columns -->
{% if profiles or rates or phases %}
<h5><i class="bi bi-bar-chart"></i> Additional Results</h5>
<div class="plot-grid">
    {% for result in profiles %}
    <div class="card">
        <div class="card-header">
            <i class="bi bi-rulers"></i> {{ result.result_label }}
        </div>
        <div class="card-body text-center">
            {% if result.has_plot %}
            <img src="{{ url_for('simulation.result_image', id=sim.id, result_id=result.id) }}" alt="{{ result.result_label }}">
            {% endif %}
        </div>
    </div>
    {% endfor %}

    {% for result in rates %}
    <div class="card">
        <div class="card-header">
            <i class="bi bi-speedometer2"></i> {{ result.result_label }}
        </div>
        <div class="card-body text-center">
            {% if result.has_plot %}
            <img src="{{ url_for('simulation.result_image', id=sim.id, result_id=result.id) }}" alt="{{ result.result_label }}">
            {% endif %}
        </div>
    </div>
    {% endfor %}

    {% for result in phases %}
    <div class="card">
        <div class="card-header">
            <i class="bi bi-pie-chart"></i> {{ result.result_label }}
        </div>
        <div class="card-body text-center">
            {% if result.has_plot %}
            <img src="{{ url_for('simulation.result_image', id=sim.id, result_id=result.id) }}" alt="{{ result.result_label }}">
            {% endif %}
            <div class="mt-1">
                {% for phase, fraction in result.phases_dict.items() %}
                {% if fraction > 0.01 %}
                <span class="badge
                    {% if 'martensite' in phase %}bg-danger
                    {% elif 'bainite' in phase %}bg-warning text-dark
                    {% elif 'ferrite' in phase %}bg-success
                    {% elif 'pearlite' in phase %}bg-primary
                    {% else %}bg-secondary{% endif %}
                    me-1">{{ phase|replace('_', ' ')|title }}: {{ (fraction * 100)|round(1) }}%</span>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% elif sim.status == 'ready' %}
<div class="alert alert-info">
    <h5><i class="bi bi-play-circle"></i> Ready to Run</h5>
    <p class="mb-2">The simulation is configured and ready to execute.</p>
    <form method="post" action="{{ url_for('simulation.run', id=sim.id) }}" class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-success">
            <i class="bi bi-play-fill"></i> Run Simulation
        </button>
    </form>
</div>

{% elif sim.status == 'draft' %}
<div class="alert alert-warning">
    <h5><i class="bi bi-gear"></i> Configuration Required</h5>
    <p class="mb-2">Please configure the simulation geometry and heat treatment parameters.</p>
    <a href="{{ url_for('simulation.setup', id=sim.id) }}" class="btn btn-primary">
        <i class="bi bi-gear"></i> Configure Simulation
    </a>
</div>

{% elif sim.status == 'running' %}
<div class="alert alert-info">
    <h5><i class="bi bi-hourglass-split"></i> Running...</h5>
    <p class="mb-2">The simulation is currently running. Please wait...</p>
    <div class="progress" style="height: 8px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 50%"></div>
    </div>
</div>
{% endif %}
{% endblock %}

{% extends "base.html" %}

{% block title %}Specimen Data{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('tensile.index') }}">Tensile Tests</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('tensile.new') }}">New Test</a></li>
        <li class="breadcrumb-item active">Specimen Data</li>
    </ol>
</nav>

<div class="row">
    <!-- CSV Info Card -->
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="bi bi-check-circle"></i> Loaded Data</h6>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-5">File:</dt>
                    <dd class="col-7 text-truncate">{{ csv_info.filename }}</dd>

                    <dt class="col-5">Test Run:</dt>
                    <dd class="col-7">{{ csv_info.test_run_name }}</dd>

                    <dt class="col-5">Date:</dt>
                    <dd class="col-7">{{ csv_info.test_date }}</dd>

                    <dt class="col-5">Data Points:</dt>
                    <dd class="col-7">{{ csv_info.num_points }}</dd>

                    <dt class="col-5">Max Force:</dt>
                    <dd class="col-7">{{ "%.2f"|format(csv_info.max_force) }} kN</dd>

                    <dt class="col-5">Max Extension:</dt>
                    <dd class="col-7">{{ "%.3f"|format(csv_info.max_extension) }} mm</dd>
                </dl>
            </div>
        </div>

        {% if certificate %}
        <!-- Linked Certificate Card -->
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-link-45deg"></i> Linked Certificate</h6>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-5">Certificate:</dt>
                    <dd class="col-7">
                        <a href="{{ url_for('certificates.view', cert_id=certificate.id) }}">
                            <strong>{{ certificate.certificate_number_with_rev }}</strong>
                        </a>
                    </dd>

                    <dt class="col-5">Customer:</dt>
                    <dd class="col-7">{{ certificate.customer or '-' }}</dd>

                    <dt class="col-5">Project:</dt>
                    <dd class="col-7">{{ certificate.test_project or '-' }}</dd>

                    <dt class="col-5">Material:</dt>
                    <dd class="col-7">{{ certificate.material or '-' }}</dd>
                </dl>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Specimen Form -->
    <div class="col-md-9">
        <div class="card shadow">
            <div class="card-header {{ 'bg-warning text-dark' if reanalyze else 'bg-primary text-white' }}">
                <h4 class="mb-0">
                    <i class="bi bi-{{ 'arrow-repeat' if reanalyze else 'rulers' }}"></i>
                    {{ 'Re-analyze Test' if reanalyze else 'Specimen Geometry & Test Setup' }}
                </h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('tensile.specimen') }}">
                    {{ form.hidden_tag() }}

                    <!-- Row 1: Identification -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            {{ form.specimen_id.label(class="form-label") }}
                            {{ form.specimen_id(class="form-control") }}
                            {% for error in form.specimen_id.errors %}
                            <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-3">
                            {{ form.material.label(class="form-label") }}
                            {{ form.material(class="form-control", placeholder="e.g., S355J2") }}
                        </div>
                        <div class="col-md-3">
                            {{ form.batch_number.label(class="form-label") }}
                            {{ form.batch_number(class="form-control") }}
                        </div>
                        <div class="col-md-3">
                            {{ form.test_standard.label(class="form-label") }}
                            {{ form.test_standard(class="form-select") }}
                        </div>
                    </div>

                    <!-- Row 2: Specimen Type, Yield Method, Temperature -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            {{ form.specimen_type.label(class="form-label fw-bold") }}
                            {{ form.specimen_type(class="form-select", id="specimen_type") }}
                        </div>
                        <div class="col-md-3">
                            {{ form.yield_method.label(class="form-label fw-bold") }}
                            {{ form.yield_method(class="form-select") }}
                        </div>
                        <div class="col-md-3">
                            {{ form.test_temperature.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.test_temperature(class="form-control", value="23") }}
                                <span class="input-group-text">°C</span>
                            </div>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <div class="form-check">
                                {{ form.use_displacement_only(class="form-check-input", id="use_displacement_only") }}
                                {{ form.use_displacement_only.label(class="form-check-label fw-bold text-warning") }}
                                <div class="form-text small">E from 10-30% Rm, strain zeroed at 10% Rm</div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <!-- BEFORE TEST Column -->
                        <div class="col-md-6">
                            <h5 class="text-primary mb-3"><i class="bi bi-box-arrow-in-right"></i> Before Test (Initial)</h5>

                            <!-- Round specimen fields -->
                            <div id="round-initial">
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        {{ form.D0.label(class="form-label fw-bold") }}
                                        <div class="input-group">
                                            {{ form.D0(class="form-control", step="0.01", placeholder="d₀") }}
                                            <span class="input-group-text">mm</span>
                                        </div>
                                        <small class="text-muted">For cross-section area and Z%</small>
                                        {% for error in form.D0.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Rectangular specimen fields -->
                            <div id="rect-initial" style="display: none;">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        {{ form.a0.label(class="form-label fw-bold") }}
                                        <div class="input-group">
                                            {{ form.a0(class="form-control", step="0.01", placeholder="a₀") }}
                                            <span class="input-group-text">mm</span>
                                        </div>
                                        {% for error in form.a0.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.b0.label(class="form-label fw-bold") }}
                                        <div class="input-group">
                                            {{ form.b0(class="form-control", step="0.01", placeholder="b₀") }}
                                            <span class="input-group-text">mm</span>
                                        </div>
                                        {% for error in form.b0.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <small class="text-muted">For cross-section area and Z%</small>
                            </div>

                            <!-- Common length fields -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    {{ form.L0.label(class="form-label fw-bold") }}
                                    <div class="input-group">
                                        {{ form.L0(class="form-control", step="0.1", placeholder="Le") }}
                                        <span class="input-group-text">mm</span>
                                    </div>
                                    <small class="text-muted">For extensometer strain</small>
                                    {% for error in form.L0.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-6">
                                    {{ form.Lp.label(class="form-label fw-bold") }}
                                    <div class="input-group">
                                        {{ form.Lp(class="form-control", step="0.1", placeholder="Lc") }}
                                        <span class="input-group-text">mm</span>
                                    </div>
                                    <small class="text-muted">For displacement strain</small>
                                    {% for error in form.Lp.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- AFTER TEST Column -->
                        <div class="col-md-6">
                            <h5 class="text-success mb-3"><i class="bi bi-box-arrow-right"></i> After Test (Final)</h5>

                            <!-- Round specimen final -->
                            <div id="round-final">
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        {{ form.D1.label(class="form-label fw-bold") }}
                                        <div class="input-group">
                                            {{ form.D1(class="form-control", step="0.01", placeholder="df") }}
                                            <span class="input-group-text">mm</span>
                                        </div>
                                        <small class="text-muted">For Z% and true stress at break</small>
                                        {% for error in form.D1.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Rectangular specimen final -->
                            <div id="rect-final" style="display: none;">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        {{ form.au.label(class="form-label fw-bold") }}
                                        <div class="input-group">
                                            {{ form.au(class="form-control", step="0.01", placeholder="au") }}
                                            <span class="input-group-text">mm</span>
                                        </div>
                                        {% for error in form.au.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.bu.label(class="form-label fw-bold") }}
                                        <div class="input-group">
                                            {{ form.bu(class="form-control", step="0.01", placeholder="bu") }}
                                            <span class="input-group-text">mm</span>
                                        </div>
                                        {% for error in form.bu.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <small class="text-muted">For Z% calculation</small>
                            </div>

                            <!-- Common final length fields -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    {{ form.L1.label(class="form-label fw-bold") }}
                                    <div class="input-group">
                                        {{ form.L1(class="form-control", step="0.1", placeholder="Lu") }}
                                        <span class="input-group-text">mm</span>
                                    </div>
                                    <small class="text-muted">For A% calculation</small>
                                    {% for error in form.L1.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-6">
                                    {{ form.Lf.label(class="form-label fw-bold") }}
                                    <div class="input-group">
                                        {{ form.Lf(class="form-control", step="0.1", placeholder="Lcf") }}
                                        <span class="input-group-text">mm</span>
                                    </div>
                                    <small class="text-muted">Optional</small>
                                    {% for error in form.Lf.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Notes -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            {{ form.notes.label(class="form-label") }}
                            {{ form.notes(class="form-control", rows="2", placeholder="Test notes, observations...") }}
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        {% if reanalyze %}
                        <a href="{{ url_for('tensile.view', test_id=test_id) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-warning btn-lg">
                            <i class="bi bi-arrow-repeat"></i> Re-run Analysis
                        </button>
                        {% else %}
                        <a href="{{ url_for('tensile.new') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Upload
                        </a>
                        {{ form.submit(class="btn btn-success btn-lg") }}
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const specimenType = document.getElementById('specimen_type');
    const roundInitial = document.getElementById('round-initial');
    const rectInitial = document.getElementById('rect-initial');
    const roundFinal = document.getElementById('round-final');
    const rectFinal = document.getElementById('rect-final');

    function updateFields() {
        if (specimenType.value === 'round') {
            roundInitial.style.display = 'block';
            rectInitial.style.display = 'none';
            roundFinal.style.display = 'block';
            rectFinal.style.display = 'none';
        } else {
            roundInitial.style.display = 'none';
            rectInitial.style.display = 'block';
            roundFinal.style.display = 'none';
            rectFinal.style.display = 'block';
        }
    }

    specimenType.addEventListener('change', updateFields);
    updateFields(); // Initial state
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Specimen Data{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('tensile.index') }}">Tensile Tests</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('tensile.new') }}">New Test</a></li>
        <li class="breadcrumb-item active">Specimen Data</li>
    </ol>
</nav>

<div class="row">
    <!-- CSV Info Card -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="bi bi-check-circle"></i> Loaded Data</h6>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-5">File:</dt>
                    <dd class="col-7 text-truncate">{{ csv_info.filename }}</dd>

                    <dt class="col-5">Test Run:</dt>
                    <dd class="col-7">{{ csv_info.test_run_name }}</dd>

                    <dt class="col-5">Date:</dt>
                    <dd class="col-7">{{ csv_info.test_date }}</dd>

                    <dt class="col-5">Data Points:</dt>
                    <dd class="col-7">{{ csv_info.num_points }}</dd>

                    <dt class="col-5">Max Force:</dt>
                    <dd class="col-7">{{ "%.2f"|format(csv_info.max_force) }} kN</dd>

                    <dt class="col-5">Max Extension:</dt>
                    <dd class="col-7">{{ "%.3f"|format(csv_info.max_extension) }} mm</dd>
                </dl>
            </div>
        </div>

        {% if certificate %}
        <!-- Linked Certificate Card -->
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-link-45deg"></i> Linked Certificate</h6>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-5">Certificate:</dt>
                    <dd class="col-7">
                        <a href="{{ url_for('certificates.view', cert_id=certificate.id) }}">
                            <strong>{{ certificate.certificate_number_with_rev }}</strong>
                        </a>
                    </dd>

                    <dt class="col-5">Customer:</dt>
                    <dd class="col-7">{{ certificate.customer or '-' }}</dd>

                    <dt class="col-5">Project:</dt>
                    <dd class="col-7">{{ certificate.test_project or '-' }}</dd>

                    <dt class="col-5">Material:</dt>
                    <dd class="col-7">{{ certificate.material or '-' }}</dd>
                </dl>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Specimen Form -->
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-rulers"></i> Specimen Geometry</h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    {{ form.hidden_tag() }}

                    <!-- Specimen Identification -->
                    <h6 class="text-muted mb-3">Identification</h6>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            {{ form.specimen_id.label(class="form-label") }}
                            {{ form.specimen_id(class="form-control") }}
                            {% for error in form.specimen_id.errors %}
                            <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-4">
                            {{ form.material.label(class="form-label") }}
                            {{ form.material(class="form-control", placeholder="e.g., S355J2") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.batch_number.label(class="form-label") }}
                            {{ form.batch_number(class="form-control") }}
                        </div>
                    </div>

                    <hr>

                    <!-- Specimen Type -->
                    <h6 class="text-muted mb-3">Geometry</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            {{ form.specimen_type.label(class="form-label") }}
                            {{ form.specimen_type(class="form-select", id="specimen_type") }}
                        </div>
                        <div class="col-md-6">
                            {{ form.test_standard.label(class="form-label") }}
                            {{ form.test_standard(class="form-select") }}
                        </div>
                    </div>

                    <!-- Round Specimen Fields -->
                    <div id="round-fields" class="row mb-3">
                        <div class="col-md-4">
                            {{ form.diameter.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.diameter(class="form-control", step="0.01") }}
                                <span class="input-group-text">mm</span>
                            </div>
                            {% for error in form.diameter.errors %}
                            <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Rectangular Specimen Fields -->
                    <div id="rect-fields" class="row mb-3" style="display: none;">
                        <div class="col-md-4">
                            {{ form.width.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.width(class="form-control", step="0.01") }}
                                <span class="input-group-text">mm</span>
                            </div>
                            {% for error in form.width.errors %}
                            <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-4">
                            {{ form.thickness.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.thickness(class="form-control", step="0.01") }}
                                <span class="input-group-text">mm</span>
                            </div>
                            {% for error in form.thickness.errors %}
                            <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Common Geometry -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            {{ form.gauge_length.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.gauge_length(class="form-control", step="0.1", value="50") }}
                                <span class="input-group-text">mm</span>
                            </div>
                            {% for error in form.gauge_length.errors %}
                            <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-4">
                            {{ form.parallel_length.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.parallel_length(class="form-control", step="0.1") }}
                                <span class="input-group-text">mm</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            {{ form.test_temperature.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.test_temperature(class="form-control", value="23") }}
                                <span class="input-group-text">Â°C</span>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Post-Fracture Measurements -->
                    <h6 class="text-muted mb-3">Post-Fracture (Optional)</h6>
                    <div class="row mb-3">
                        <div class="col-md-4" id="final-diameter-group">
                            {{ form.final_diameter.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.final_diameter(class="form-control", step="0.01") }}
                                <span class="input-group-text">mm</span>
                            </div>
                            <small class="text-muted">For reduction of area (Z%)</small>
                        </div>
                        <div class="col-md-4">
                            {{ form.final_gauge_length.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.final_gauge_length(class="form-control", step="0.1") }}
                                <span class="input-group-text">mm</span>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="mb-3">
                        {{ form.notes.label(class="form-label") }}
                        {{ form.notes(class="form-control", rows="2") }}
                    </div>

                    <div class="d-grid gap-2">
                        {{ form.submit(class="btn btn-success btn-lg") }}
                        <a href="{{ url_for('tensile.new') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Upload
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const specimenType = document.getElementById('specimen_type');
    const roundFields = document.getElementById('round-fields');
    const rectFields = document.getElementById('rect-fields');
    const finalDiameterGroup = document.getElementById('final-diameter-group');

    function updateFields() {
        if (specimenType.value === 'round') {
            roundFields.style.display = 'flex';
            rectFields.style.display = 'none';
            finalDiameterGroup.style.display = 'block';
        } else {
            roundFields.style.display = 'none';
            rectFields.style.display = 'flex';
            finalDiameterGroup.style.display = 'none';
        }
    }

    specimenType.addEventListener('change', updateFields);
    updateFields(); // Initial state
});
</script>
{% endblock %}

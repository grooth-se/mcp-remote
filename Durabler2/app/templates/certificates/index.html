{% extends "base.html" %}

{% block title %}Certificate Register{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="bi bi-journal-text"></i> Certificate Register</h2>
        <p class="text-muted">Central hub for all test reports (DUR-YYYY-NNNN)</p>
    </div>
    <div>
        {% if current_user.role == 'admin' %}
        <a href="{{ url_for('certificates.import_excel') }}" class="btn btn-outline-info me-2">
            <i class="bi bi-file-earmark-excel"></i> Import
        </a>
        {% endif %}
        <a href="{{ url_for('certificates.new') }}" class="btn btn-success btn-lg">
            <i class="bi bi-plus-circle"></i> New Test Entry
        </a>
    </div>
</div>

<!-- Quick Lookup -->
<div class="card mb-4 border-primary">
    <div class="card-body">
        <form method="GET" class="row g-2 align-items-end">
            <div class="col-md-4">
                <label class="form-label fw-bold">Quick Lookup - Open Certificate</label>
                <div class="input-group">
                    <span class="input-group-text">DUR-</span>
                    <input type="text" name="lookup" class="form-control"
                           placeholder="2026-1001" id="cert-lookup-input">
                    <button type="button" class="btn btn-primary" id="lookup-btn">
                        <i class="bi bi-search"></i> Open
                    </button>
                </div>
            </div>
            <div class="col-md-8">
                <div class="d-flex gap-2 justify-content-end">
                    <small class="text-muted align-self-center">Recent:</small>
                    {% for cert in certificates[:5] %}
                    <a href="{{ url_for('certificates.view', cert_id=cert.id) }}"
                       class="btn btn-sm btn-outline-secondary">
                        {{ cert.certificate_number }}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Filter Bar -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="form-label">Year</label>
                <select name="year" class="form-select">
                    <option value="All" {{ 'selected' if year_filter == 'All' or not year_filter else '' }}>All Years</option>
                    {% for y in years %}
                    <option value="{{ y }}" {{ 'selected' if year_filter|string == y|string else '' }}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Search</label>
                <input type="text" name="search" class="form-control"
                       value="{{ search_term }}" placeholder="Project, customer, material...">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Search
                </button>
                {% if search_term or (year_filter and year_filter != 'All') %}
                <a href="{{ url_for('certificates.index') }}" class="btn btn-outline-secondary">Clear</a>
                {% endif %}
            </div>
            <div class="col-md-4 text-end">
                <span class="text-muted">{{ certificates|length }} certificates</span>
            </div>
        </form>
    </div>
</div>

<!-- Certificates Table -->
{% if certificates %}
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Certificate No.</th>
                        <th>Date</th>
                        <th>Provningsorder</th>
                        <th>Customer</th>
                        <th>Standard</th>
                        <th>Material</th>
                        <th class="text-center">Tests</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cert in certificates %}
                    <tr class="align-middle">
                        <td>
                            <a href="{{ url_for('certificates.view', cert_id=cert.id) }}" class="fw-bold text-decoration-none text-primary">
                                {{ cert.certificate_number_with_rev }}
                            </a>
                        </td>
                        <td>{{ cert.cert_date.strftime('%Y-%m-%d') if cert.cert_date else '-' }}</td>
                        <td>{{ cert.provningsorder or '-' }}</td>
                        <td>{{ cert.customer or '-' }}</td>
                        <td><small>{{ cert.test_standard or '-' }}</small></td>
                        <td><small>{{ cert.material or '-' }}</small></td>
                        <td class="text-center">
                            {% set test_count = cert.test_records.count() %}
                            {% if test_count > 0 %}
                            <span class="badge bg-primary">{{ test_count }}</span>
                            {% else %}
                            <span class="badge bg-light text-muted">0</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if cert.reported and cert.invoiced %}
                            <span class="badge bg-success"><i class="bi bi-check-all"></i> Complete</span>
                            {% elif cert.reported %}
                            <span class="badge bg-warning text-dark"><i class="bi bi-check"></i> Reported</span>
                            {% else %}
                            <span class="badge bg-secondary">Open</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('certificates.view', cert_id=cert.id) }}"
                                   class="btn btn-primary" title="Open Test Entry">
                                    <i class="bi bi-folder2-open"></i> Open
                                </a>
                                <a href="{{ url_for('certificates.edit', cert_id=cert.id) }}"
                                   class="btn btn-outline-secondary" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-journal display-1 text-muted mb-3"></i>
        <h4>No Certificates Found</h4>
        {% if search_term %}
        <p class="text-muted">No certificates match your search criteria.</p>
        <a href="{{ url_for('certificates.index') }}" class="btn btn-outline-primary">Clear Search</a>
        {% else %}
        <p class="text-muted">Create your first certificate to get started.</p>
        <a href="{{ url_for('certificates.new') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> New Certificate
        </a>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const lookupInput = document.getElementById('cert-lookup-input');
    const lookupBtn = document.getElementById('lookup-btn');

    function openCertificate() {
        let value = lookupInput.value.trim();
        if (!value) return;

        // Add DUR- prefix if not present
        if (!value.toUpperCase().startsWith('DUR-')) {
            value = 'DUR-' + value;
        }

        // Search for certificate
        fetch(`{{ url_for('certificates.search') }}?q=${encodeURIComponent(value)}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    // Redirect to view page
                    window.location.href = `/certificates/${data[0].id}`;
                } else {
                    alert('Certificate not found: ' + value);
                }
            })
            .catch(err => {
                alert('Error searching: ' + err);
            });
    }

    lookupBtn.addEventListener('click', openCertificate);
    lookupInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            openCertificate();
        }
    });
});
</script>
{% endblock %}
